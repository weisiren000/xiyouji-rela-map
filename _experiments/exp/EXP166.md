# EXP166: 事件关系图谱球体渲染参数GUI面板实现

## 时间
2025-06-28

## 对话背景
用户需要为事件关系图谱的球体渲染参数创建一个GUI面板，用于实时调试和配置球体的视觉效果。

## 需求分析
事件关系图谱中包含多种可调参数：
1. **球体基础属性**: 大小、透明度、金属度、粗糙度
2. **动画效果**: 浮动强度/速度、脉冲强度/速度、旋转速度/幅度
3. **交互状态**: 悬浮/长按/拖拽时的大小和颜色变化
4. **连接线属性**: 透明度、宽度
5. **几何体属性**: 球体分段数和环数

## 实施方案

### 1. 创建配置类型定义
**文件**: `src/types/eventCharacterGraph.ts`

**核心接口**:
```typescript
export interface EventCharacterGraphConfig {
  // 球体基础属性
  baseSize: number
  opacity: number
  metalness: number
  roughness: number
  
  // 动画效果
  floatIntensity: number
  floatSpeed: number
  pulseIntensity: number
  pulseSpeed: number
  rotationSpeed: number
  rotationAmplitude: number
  
  // 交互状态倍数
  hoverSizeMultiplier: number
  longPressSizeMultiplier: number
  dragSizeMultiplier: number
  
  // 交互状态颜色
  hoverColorMultiplier: number
  longPressGoldLerp: number
  dragGoldMultiplier: number
  
  // 连接线属性
  lineOpacity: number
  lineOpacityDrag: number
  lineWidth: number
  
  // 几何体属性
  sphereSegments: number
  sphereRings: number
}
```

**预设配置**:
- **默认**: 标准配置
- **低调**: 减弱动画效果，适合性能较低的设备
- **动感**: 增强动画效果，更有活力
- **优雅**: 精致的视觉效果，适合展示
- **性能优化**: 降低几何体复杂度，提升性能

### 2. 扩展状态管理
**文件**: `src/stores/useGalaxyStore.ts`

**新增内容**:
```typescript
interface GalaxyState {
  // 新增配置
  eventCharacterGraphConfig: EventCharacterGraphConfig
  
  // 新增更新方法
  updateEventCharacterGraphConfig: (config: Partial<EventCharacterGraphConfig>) => void
}
```

### 3. 创建GUI控制面板
**文件**: `src/components/controls/EventCharacterGraphGUI/EventCharacterGraphGUI.tsx`

**功能特性**:
- **预设配置**: 5种预设配置，一键应用
- **分组管理**: 6个参数分组，便于管理
- **实时更新**: 参数变化立即生效
- **默认收拢**: 所有文件夹默认关闭，减少界面干扰
- **位置可配置**: 支持自定义面板位置

**参数分组**:
1. **预设配置**: 快速应用预设
2. **球体基础属性**: 大小、透明度、材质属性
3. **动画效果**: 浮动、脉冲、旋转参数
4. **交互状态**: 悬浮、长按、拖拽的视觉反馈
5. **连接线属性**: 线条透明度和宽度
6. **几何体属性**: 球体分段数和环数

### 4. 修改EventCharacterGraph组件
**文件**: `src/components/three/Scenes/EventDetailScene/components/EventCharacterGraph.tsx`

**核心改进**:
- 集成状态管理，使用配置参数
- 替换硬编码数值为配置参数
- 实现参数的实时响应

**参数映射**:
```typescript
// 浮动效果
const floatIntensity = isDragging(i) 
  ? eventCharacterGraphConfig.floatIntensity * 0.3 
  : eventCharacterGraphConfig.floatIntensity
tempObject.position.y += Math.sin(time * eventCharacterGraphConfig.floatSpeed + i * 0.5) * floatIntensity

// 大小控制
let baseSize = character.size * eventCharacterGraphConfig.baseSize
if (isDragging(i)) {
  baseSize *= eventCharacterGraphConfig.dragSizeMultiplier
} else if (isLongPressing(i)) {
  baseSize *= eventCharacterGraphConfig.longPressSizeMultiplier
} else if (isHovered(i)) {
  baseSize *= eventCharacterGraphConfig.hoverSizeMultiplier
}

// 脉冲效果
const pulseScale = 1 + Math.sin(time * eventCharacterGraphConfig.pulseSpeed + i * 0.7) * eventCharacterGraphConfig.pulseIntensity
```

### 5. 集成到EventDetailScene
**文件**: `src/components/three/Scenes/EventDetailScene/EventDetailScene.tsx`

**新增GUI面板**:
```typescript
{/* 关系图谱GUI控制面板 */}
<EventCharacterGraphGUI 
  visible={showCharacterGraph}
  position={{ bottom: 20, left: 20 }}
/>
```

## 技术要点

### 1. 配置参数设计
- **合理范围**: 每个参数都有合适的取值范围
- **默认值**: 基于现有实现的最佳实践
- **预设系统**: 提供多种使用场景的预设

### 2. 实时响应机制
- **状态同步**: GUI变化立即更新状态
- **组件响应**: 组件监听状态变化并实时更新
- **热更新**: 支持开发时的热更新

### 3. 性能优化
- **几何体控制**: 可调节球体复杂度
- **动画强度**: 可降低动画计算量
- **预设优化**: 提供性能优化预设

### 4. 用户体验
- **分组管理**: 参数按功能分组
- **默认收拢**: 避免界面过于复杂
- **预设快捷**: 一键应用常用配置

## 实现效果
1. ✅ 完整的GUI控制面板，支持所有渲染参数
2. ✅ 5种预设配置，适应不同使用场景
3. ✅ 实时参数调整，立即看到效果
4. ✅ 分组管理，界面清晰易用
5. ✅ 集成到事件详情视图，位置合理
6. ✅ 性能优化选项，适应不同设备

## 使用方法
1. 进入空银河系页面
2. 点击任意事件点进入局部视图
3. 在左下角找到"关系图谱控制"面板
4. 展开相应的参数分组进行调整
5. 使用预设配置快速切换效果

## 后续优化建议
1. 添加参数重置功能
2. 支持自定义预设的保存和加载
3. 添加参数动画过渡效果
4. 考虑添加更多视觉效果选项
