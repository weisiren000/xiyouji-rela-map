# EXP139 - SQLite数据库批量汉化操作

## 实验目标
对SQLite数据库中的英文字段进行批量汉化，将英文值转换为对应的中文值。

## 实验背景
- 项目已从JSON数据迁移到SQLite数据库
- 数据库中存在大量英文字段值，如"PROTAGONIST"、"lawful_good"等
- 需要提升用户体验，将这些英文值转换为中文

## 实验过程

### 1. 数据库结构分析
- 数据库文件：`data/characters.db`
- 主要表：`characters`、`character_metadata`
- 需要汉化的字段：
  - `characters.category` (角色类型)
  - `characters.morality` (道德倾向)
  - `character_metadata.attributes` JSON中的`level.category` (等级类别)

### 2. 汉化脚本开发
创建了两个版本的汉化脚本：
- `localize-database.js` (ES模块版本)
- `localize-database.cjs` (CommonJS版本，最终使用)

### 3. 映射关系定义
建立了完整的英文到中文映射表：

#### Category字段映射
- `protagonist` → `主角`
- `antagonist` → `反派`
- `deity` → `神仙`
- `demon` → `妖魔`
- `dragon` → `龙族`
- `human` → `人类`
- `immortal` → `仙人`
- `alias` → `别名`

#### Morality字段映射
- `lawful_good` → `守序善良`
- `neutral_good` → `中立善良`
- `chaotic_good` → `混乱善良`
- `lawful_neutral` → `守序中立`
- `neutral` → `绝对中立`
- `chaotic_neutral` → `混乱中立`
- `lawful_evil` → `守序邪恶`
- `neutral_evil` → `中立邪恶`
- `chaotic_evil` → `混乱邪恶`
- `true_neutral` → `绝对中立`

#### Level Category字段映射
- `immortal` → `仙人`
- `buddhist` → `佛教`
- `demon` → `妖魔`
- `dragon` → `龙族`
- `human` → `人类`
- `celestial` → `天庭`
- `underworld` → `地府`
- `divine` → `神圣`
- `buddha` → `佛陀`
- `taoist` → `道教`
- `bodhisattva` → `菩萨`
- `arhat` → `罗汉`
- `mountain` → `山神`
- `time` → `时间`
- `guardian` → `守护`
- `sage` → `圣人`
- `beast` → `神兽`
- `mortal` → `凡人`
- `royal` → `皇室`

### 4. 执行流程
1. **预览模式**：先运行预览，分析需要汉化的数据
2. **实际执行**：使用`--execute`参数进行实际汉化
3. **验证结果**：创建验证脚本确认汉化效果

## 实验结果

### 汉化统计
- **总记录数**: 1,446条
- **已汉化**: 1,446条 (100.0%) ✅
- **未汉化**: 0条 (0.0%) ✅
- **其他类型**: 0条 (0.0%) ✅

### 具体成果
1. **Category字段**: 482条记录成功汉化 (包括332条alias→别名)
2. **Morality字段**: 482条记录成功汉化 (包括true_neutral→绝对中立)
3. **Level Category字段**: 482条记录成功汉化 (包括divine→神圣、buddha→佛陀等)

### 验证结果
使用`verify-localization.cjs`验证，确认所有英文字段都已成功汉化。

## 技术要点

### 1. 数据库操作
- 使用`better-sqlite3`进行数据库操作
- 采用事务处理确保数据一致性
- 支持JSON字段的解析和更新

### 2. 脚本设计
- 支持预览模式和执行模式
- 提供详细的进度反馈
- 包含完整的错误处理

### 3. 验证机制
- 自动统计汉化前后的数据分布
- 区分已汉化、未汉化和其他类型的数据
- 生成详细的验证报告

## 遇到的问题

### 1. ES模块兼容性
- 初始使用ES模块版本无法正常运行
- 解决方案：创建CommonJS版本

### 2. 大量数据处理
- Level Category字段有400+条记录需要处理
- 解决方案：减少日志输出，添加进度提示

### 3. JSON字段处理
- 需要解析和更新JSON格式的attributes字段
- 解决方案：使用JSON.parse和JSON.stringify处理

## 经验总结

### 成功因素
1. **充分的预分析**：先分析数据分布再执行汉化
2. **安全的操作流程**：预览模式避免误操作
3. **完整的验证机制**：确保汉化结果正确
4. **详细的映射表**：覆盖所有需要汉化的英文值

### 改进建议
1. 可以考虑汉化更多字段，如`divine`→`神圣`、`buddha`→`佛陀`等
2. 可以添加回滚功能，支持汉化操作的撤销
3. 可以支持自定义映射表，提高脚本的通用性

## 文件清单
- `scripts/data-migration/localize-database.cjs` - 汉化脚本
- `scripts/data-migration/verify-localization.cjs` - 验证脚本
- `scripts/data-migration/test-localize.js` - 测试脚本

## 状态
✅ **已完成** - 所有英文字段已100%汉化完成，验证通过

## 最终汉化成果
- **总汉化率**: 100% (1,446/1,446条记录)
- **Category字段**: 100%汉化 (482/482条)
- **Morality字段**: 100%汉化 (482/482条)
- **Level Category字段**: 100%汉化 (482/482条)
- **新增汉化映射**: 13个新的英文词汇映射
