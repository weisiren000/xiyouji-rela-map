# EXP140: 数据库汉化后球体颜色映射修复

## 问题描述
数据库汉化后，角色球体失去了颜色区分，所有球体都显示为白色。用户反馈：
- 球体颜色没有区分
- 数据库加载有问题
- 角色类型等数据全错了

## 根本原因分析
数据库汉化后，category字段从英文值（如'protagonist'）变为中文值（如'主角'），但前后端的颜色映射函数仍在使用英文映射，导致无法正确匹配颜色。

## 解决方案

### 1. 后端服务器修复 (dataServer-sqlite.js)
更新了三个关键函数的映射逻辑：

#### 角色类型映射
```javascript
function mapCharacterType(category) {
  const typeMap = {
    // 中文映射
    '主角': 'PROTAGONIST',
    '神仙': 'DEITY', 
    '妖魔': 'DEMON',
    '人类': 'HUMAN',
    '龙族': 'DRAGON',
    '天庭': 'CELESTIAL',
    '佛教': 'BUDDHIST',
    '地府': 'UNDERWORLD',
    '仙人': 'IMMORTAL',
    '反派': 'ANTAGONIST',
    '别名': 'ALIAS',
    // 兼容英文映射
    'protagonist': 'PROTAGONIST',
    // ... 其他英文映射
  }
  return typeMap[category] || 'HUMAN'
}
```

#### 势力映射
```javascript
function mapFaction(category, attributes) {
  // 中文分类映射
  if (category === '主角' || category === 'protagonist') return '取经团队'
  if (category === '佛教' || category === 'buddhist') return '佛教'
  if (category === '天庭' || category === 'celestial') return '天庭'
  if (category === '神仙' || category === 'deity') return '天庭'
  if (category === '妖魔' || category === 'demon') return '妖魔'
  if (category === '龙族' || category === 'dragon') return '龙族'
  if (category === '地府' || category === 'underworld') return '地府'
  if (category === '人类' || category === 'human') return '凡间'
  if (category === '仙人' || category === 'immortal') return '天庭'
  if (category === '反派' || category === 'antagonist') return '反派势力'
  // ... 其他映射
  return '其他'
}
```

#### 颜色映射
```javascript
const colorMap = {
  // 中文分类映射
  '主角': '#FFD700',           // 金色
  '神仙': '#87CEEB',           // 天蓝色
  '妖魔': '#FF6347',           // 红色
  '龙族': '#00CED1',           // 青色
  '佛教': '#DDA0DD',           // 紫色
  '天庭': '#F0E68C',           // 卡其色
  '地府': '#696969',           // 灰色
  '人类': '#FFA500',           // 橙色
  '仙人': '#98FB98',           // 浅绿色
  '反派': '#DC143C',           // 深红色
  '别名': '#C0C0C0',           // 银色
  // 兼容英文分类映射
  'protagonist': '#FFD700',    // 金色
  // ... 其他英文映射
}
```

### 2. 前端组件修复 (CharacterSpheresSimple.tsx)
更新了前端的颜色映射函数和位置生成函数：

#### 颜色映射函数
```typescript
const getCharacterColor = (category: string): string => {
  const colorMap = {
    // 中文分类映射
    '主角': '#FFD700',           // 金色
    '神仙': '#87CEEB',           // 天蓝色
    '妖魔': '#FF6347',           // 红色
    '龙族': '#00CED1',           // 青色
    '佛教': '#DDA0DD',           // 紫色
    '天庭': '#F0E68C',           // 卡其色
    '地府': '#696969',           // 灰色
    '人类': '#FFA500',           // 橙色
    '仙人': '#98FB98',           // 浅绿色
    '反派': '#DC143C',           // 深红色
    '别名': '#C0C0C0',           // 银色
    // 兼容英文分类映射
    'protagonist': '#FFD700',    // 金色
    // ... 其他英文映射
  }
  return colorMap[category as keyof typeof colorMap] || '#FFFFFF'
}
```

#### 位置生成函数
更新了角色和别名的位置生成函数中的categoryAngles映射，添加了中文分类支持。

## 数据库分类统计
通过检查脚本确认了数据库中的实际分类分布：
- 别名: 332 个角色
- 神仙: 71 个角色  
- 反派: 31 个角色
- 妖魔: 28 个角色
- 仙人: 10 个角色
- 主角: 5 个角色
- 人类: 3 个角色
- 龙族: 2 个角色

## 技术要点

### 兼容性设计
- 同时支持中文和英文分类映射
- 确保向后兼容性
- 渐进式迁移策略

### 一致性保证
- 前后端使用相同的颜色映射逻辑
- 统一的分类命名规范
- 完整的映射覆盖

### 调试验证
- API数据验证：确认返回正确的中文分类和颜色
- 前端日志：验证颜色分组逻辑
- 数据库查询：确认实际存储的分类值

## 修改文件
1. `src/server/dataServer-sqlite.js` - 后端映射函数
2. `src/components/three/CharacterSpheresSimple.tsx` - 前端颜色映射

## 测试结果
- ✅ 服务器正确返回中文分类和对应颜色
- ✅ 前端颜色映射函数支持中文分类
- ✅ 位置生成函数支持中文分类
- ✅ API响应格式正确：`{"category":"主角","visual":{"color":"#FFD700"}}`

## 经验总结
1. **数据迁移影响评估**：汉化数据库时需要全面评估对前后端代码的影响
2. **映射函数设计**：使用兼容性映射确保平滑过渡
3. **一致性维护**：前后端颜色映射逻辑必须保持同步
4. **调试工具**：创建专门的数据验证脚本有助于快速定位问题

## 下一步
- 验证浏览器中球体颜色是否正确显示
- 检查局部视图中的角色信息显示
- 确认所有UI组件正确处理中文分类数据
