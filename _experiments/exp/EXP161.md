# EXP161: 长按拖拽功能优化修复

## 时间
2025-06-28

## 问题背景
用户反馈长按拖动的效果没做好，需要优化和修复拖拽功能的实现。

## 问题分析
通过代码审查发现了几个关键问题：
1. **移动敏感度过低**: moveScale = 0.01 导致拖拽移动幅度太小
2. **3D坐标转换不准确**: 简单的XZ平面移动不符合用户期望
3. **长按阈值过高**: 500ms长按时间过长，用户体验不佳
4. **视觉反馈不明显**: 拖拽状态的视觉提示不够清晰
5. **缺乏状态指示**: 用户不知道拖拽功能是否正在工作

## 优化方案

### 1. 改进3D拖拽算法
**问题**: 原始算法只在XZ平面移动，不考虑相机角度
**解决方案**: 基于相机方向的3D空间转换

```typescript
// 获取相机距离来调整移动敏感度
const cameraDistance = camera.position.distanceTo(prev.dragState.dragStartPosition)
const moveScale = Math.max(0.002, cameraDistance * 0.001) // 根据相机距离动态调整

// 计算相机的右向量和上向量
const cameraRight = new Vector3()
const cameraUp = new Vector3()
camera.getWorldDirection(cameraRight)
cameraRight.cross(camera.up).normalize()
cameraUp.copy(camera.up).normalize()

// 基于相机方向计算3D移动
const rightMovement = cameraRight.clone().multiplyScalar(mouseDelta.x * moveScale)
const upMovement = cameraUp.clone().multiplyScalar(-mouseDelta.y * moveScale)
```

**优势**:
- 动态移动敏感度：根据相机距离自动调整
- 相机方向感知：移动方向符合用户视角
- 拖拽范围限制：最大距离8个单位，防止拖拽过远

### 2. 降低交互阈值
**原始设置**:
```typescript
const LONG_PRESS_DURATION = 500 // 500ms
const DRAG_THRESHOLD = 5 // 5像素
```

**优化设置**:
```typescript
const LONG_PRESS_DURATION = 300 // 300ms（降低40%）
const DRAG_THRESHOLD = 3 // 3像素（降低40%）
```

**改进逻辑**:
- 长按时间达到即开始拖拽，不需要等待鼠标移动
- 清除长按状态避免重复触发

### 3. 增强视觉反馈系统
**球体大小变化**:
```typescript
if (isDragging(i)) {
  baseSize *= 1.5 // 拖拽时明显放大（从1.2提升到1.5）
} else if (isLongPressing(i)) {
  baseSize *= 1.3 // 长按时放大（从1.15提升到1.3）
}
```

**颜色变化优化**:
```typescript
if (isDragging(i)) {
  color = new Color('#FFD700').multiplyScalar(2) // 拖拽时显示金色高亮
} else if (isLongPressing(i)) {
  color = color.clone().lerp(new Color('#FFD700'), 0.5) // 长按时偏金色
}
```

### 4. 添加状态指示系统
**拖拽状态报告**:
- 长按开始: "长按中: 角色名 (300ms后可拖拽)"
- 拖拽进行: "正在拖拽: 角色名"
- 拖拽结束: 清空状态

**状态显示界面**:
```typescript
{dragStatus && (
  <div style={{
    position: 'absolute',
    top: '70px',
    right: '20px',
    backgroundColor: 'rgba(255, 215, 0, 0.9)', // 金色背景
    color: '#000',
    padding: '8px 12px',
    borderRadius: '4px',
    fontSize: '12px',
    fontWeight: 'bold',
    boxShadow: '0 2px 8px rgba(0,0,0,0.3)'
  }}>
    🎯 {dragStatus}
  </div>
)}
```

### 5. 改进用户提示
**更新交互说明**:
- 长按时间从500ms更新为300ms
- 添加视觉提示说明："长按时球体会变金色，拖拽时会明显放大"
- 扩大说明面板宽度以容纳更多信息

## 技术实现细节

### 拖拽算法优化
1. **动态敏感度**: 根据相机距离调整移动比例
2. **相机感知**: 基于相机右向量和上向量计算移动方向
3. **范围限制**: 最大拖拽距离8个单位
4. **实时反馈**: 每次位置更新都有控制台日志

### 状态管理改进
1. **状态回调**: 添加onDragStatusChange回调函数
2. **状态清理**: 长按取消时清除状态提示
3. **防重复触发**: 长按开始拖拽后清除长按状态

### 视觉效果增强
1. **金色高亮**: 拖拽时使用金色(#FFD700)突出显示
2. **大小变化**: 拖拽时放大1.5倍，长按时放大1.3倍
3. **连接线**: 拖拽时连接线透明度从0.3增加到0.6

## 实施成果

### ✅ 完成的优化
1. **3D拖拽算法重写** - 基于相机方向的准确移动
2. **交互阈值降低** - 300ms长按，3px拖拽阈值
3. **视觉反馈增强** - 金色高亮，明显的大小变化
4. **状态指示系统** - 实时显示拖拽状态
5. **用户提示更新** - 准确的操作说明

### 文件变更统计
- 修改文件：3个
  - `src/hooks/useEventCharacterInteraction.ts` (主要算法优化)
  - `src/components/three/Scenes/EventDetailScene/components/EventCharacterGraph.tsx` (视觉效果)
  - `src/components/three/Scenes/EventDetailScene/EventDetailScene.tsx` (状态显示)
- 新增代码：约100行
- 优化代码：约50行

### 性能改进
- **响应速度**: 长按时间减少40% (500ms → 300ms)
- **移动精度**: 动态敏感度，适应不同相机距离
- **视觉清晰度**: 金色高亮，1.5倍放大效果
- **用户反馈**: 实时状态指示器

## 测试验证

### 功能测试要点
1. **长按检测**: 300ms后是否开始拖拽
2. **拖拽移动**: 移动是否跟随鼠标方向
3. **视觉反馈**: 金色高亮和放大效果
4. **状态显示**: 右上角状态指示器
5. **范围限制**: 最大拖拽距离8个单位

### 预期效果
- 长按300ms后球体变金色并放大1.3倍
- 开始拖拽后球体变为金色高亮并放大1.5倍
- 右上角显示"正在拖拽: 角色名"
- 鼠标移动时角色位置实时跟随
- 连接线跟随角色移动并变得更明显

## 用户体验改进

### 操作流程优化
1. **点击角色球体** → 开始长按检测
2. **300ms后** → 球体变金色，显示"长按中"状态
3. **移动鼠标** → 开始拖拽，球体高亮放大，显示"正在拖拽"
4. **释放鼠标** → 结束拖拽，清除状态显示

### 视觉引导
- 明确的颜色变化（原色 → 金色 → 金色高亮）
- 明显的大小变化（1.0 → 1.3 → 1.5倍）
- 实时的状态文字提示
- 连接线的动态响应

## 下一步优化方向
1. **移动端适配**: 触摸事件的长按和拖拽
2. **动画过渡**: 位置变化的平滑动画
3. **碰撞检测**: 角色间的碰撞和斥力
4. **多选拖拽**: 同时选择和拖拽多个角色
5. **拖拽预览**: 拖拽过程中的半透明预览

## 技术债务
- 部分TypeScript警告需要清理
- 移动端触摸兼容性待测试
- 拖拽边界检测可以更精确
- 性能监控和优化待完善

## 学习收获
1. **3D交互算法**: 相机方向感知的拖拽实现
2. **用户体验设计**: 渐进式视觉反馈的重要性
3. **状态管理**: 复杂交互状态的清晰管理
4. **性能优化**: 动态参数调整的实现方法
