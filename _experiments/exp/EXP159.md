# EXP159: 事件角色关系图谱实现

## 时间
2025-06-27

## 对话背景
用户希望在事件详情视图中添加三维关系图谱功能，显示该事件的主要人物作为3D点。

## 需求分析
- 在事件详情视图中显示事件相关的主要人物
- 以3D球体的形式展示角色，围绕中心事件点分布
- 支持角色名称解析和数据匹配
- 提供关系图谱的显示/隐藏控制

## 实施方案

### 1. 创建事件角色关系服务
**文件**: `src/services/eventCharacterService.ts`
- **parseEventCharacters()**: 解析事件中的主要人物字符串
- **findCharacterByName()**: 根据角色名称查找角色数据
- **generateCharacterPositions()**: 生成角色在关系图谱中的3D位置
- **getCharacterColor()**: 获取角色的默认颜色
- **getEventCharacterGraphCached()**: 获取事件角色关系图谱（带缓存）

### 2. 创建关系图谱3D组件
**文件**: `src/components/three/Scenes/EventDetailScene/components/EventCharacterGraph.tsx`
- **EventCharacterGraph**: 主要的关系图谱组件
- **ConnectionLine**: 连接线组件（从中心到各个角色）
- **CharacterLabel**: 角色标签组件（暂时未使用）

### 3. 集成到事件详情场景
**文件**: `src/components/three/Scenes/EventDetailScene/EventDetailScene.tsx`
- 添加关系图谱显示控制状态
- 集成EventCharacterGraph组件
- 添加右上角控制按钮

## 技术特点

### 角色名称解析
- 支持多种分隔符：逗号、顿号、空格
- 智能角色匹配：精确匹配 → 别名匹配 → 模糊匹配
- 缓存机制避免重复API调用

### 3D布局算法
- 圆形布局：角色围绕中心事件点分布
- 随机高度变化增加视觉层次
- 连接线显示角色与事件的关联

### 视觉效果
- 角色球体带有浮动和脉冲动画
- 根据角色类型显示对应颜色
- 半透明连接线增强关系感

### 交互控制
- 右上角按钮控制关系图谱显示/隐藏
- 按钮状态颜色反馈（绿色显示/灰色隐藏）

## 数据处理流程

### 1. 事件数据解析
```typescript
事件.zhuyaorenwu → parseEventCharacters() → 角色名称数组
```

### 2. 角色数据匹配
```typescript
角色名称 → findCharacterByName() → 完整角色数据
```

### 3. 位置和颜色计算
```typescript
角色数据 → generateCharacterPositions() + getCharacterColor() → 3D渲染数据
```

### 4. 缓存管理
```typescript
事件ID → characterCache → EventCharacter[]
```

## 实施成果

### ✅ 完成的功能
1. **事件角色解析服务** - 完整的角色名称解析和匹配
2. **3D关系图谱组件** - 角色球体和连接线渲染
3. **智能角色匹配** - 支持精确、别名、模糊匹配
4. **圆形布局算法** - 角色围绕事件点分布
5. **视觉效果优化** - 动画、颜色、透明度
6. **交互控制** - 显示/隐藏切换按钮

### 文件结构
```
src/
├── services/
│   └── eventCharacterService.ts (新增)
└── components/three/Scenes/EventDetailScene/
    ├── EventDetailScene.tsx (修改)
    └── components/
        ├── EventCharacterGraph.tsx (新增)
        └── index.ts (新增)
```

## 技术亮点

### 1. 智能角色匹配算法
- 三层匹配策略确保高匹配率
- 支持角色别名和模糊匹配
- 处理各种角色名称格式

### 2. 高性能3D渲染
- 使用InstancedMesh优化多角色渲染
- 连接线使用BufferGeometry提升性能
- 动画使用useFrame优化帧率

### 3. 缓存优化
- 事件角色数据缓存避免重复计算
- API调用缓存减少网络请求

### 4. 用户体验
- 实时显示/隐藏控制
- 视觉反馈和状态指示
- 流畅的动画效果

## 测试验证
- ✅ 项目编译成功
- ✅ 开发服务器正常运行
- 🔄 待测试：关系图谱显示效果
- 🔄 待测试：角色匹配准确性

## 下一步优化
1. 测试角色名称解析的准确性
2. 优化角色球体的视觉效果
3. 添加角色标签显示
4. 考虑添加角色点击交互
5. 优化连接线的视觉效果
6. 添加更多布局算法选项
