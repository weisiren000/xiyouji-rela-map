# EXP173: 修复模型索引生成脚本路径问题

## 任务概述
**时间**: 2025-06-29
**目标**: 修复 `npm run models:index` 命令无法找到脚本文件的问题
**状态**: ✅ 已完成

## 问题分析
用户添加了新模型"赛太岁.glb"，但在运行 `npm run models:index` 时遇到错误：
```
Error: Cannot find module 'D:\codee\xiyouji-rela-map\scripts\generate-model-index.js'
```

### 根本原因
1. **路径不匹配**: package.json 中指向 `scripts/generate-model-index.js`
2. **实际位置**: 脚本实际在 `scripts/build/generate-model-index.js`
3. **相对路径错误**: 脚本内部路径 `../public/models` 应该是 `../../public/models`

## 技术修复

### 1. 修复 package.json 路径
**文件**: `package.json`

**修改前**:
```json
"models:index": "node scripts/generate-model-index.js",
"models:scan": "node scripts/generate-model-index.js",
```

**修改后**:
```json
"models:index": "node scripts/build/generate-model-index.js",
"models:scan": "node scripts/build/generate-model-index.js",
```

### 2. 修复脚本内部路径
**文件**: `scripts/build/generate-model-index.js`

**修改前**:
```javascript
const modelsDir = path.join(__dirname, '../public/models')
```

**修改后**:
```javascript
const modelsDir = path.join(__dirname, '../../public/models')
```

## 验证结果

### ✅ 脚本执行成功
```bash
> npm run models:index

✅ 模型索引生成成功!
📁 扫描目录: D:\codee\xiyouji-rela-map\public\models
📄 索引文件: D:\codee\xiyouji-rela-map\public\models\index.json
🎭 找到模型: 12 个
```

### ✅ 新模型成功检测
模型列表包含了新添加的"赛太岁.glb":
1. 哪吒.glb
2. 唐僧.glb
3. 太上老君.glb
4. 如来佛祖.glb
5. 孙悟空.glb
6. 沙僧.glb
7. 牛魔王.glb
8. 猪八戒.glb
9. 玉皇大帝.glb
10. 白龙马.glb
11. 观音菩萨.glb
12. **赛太岁.glb** ← 新添加

### ✅ 索引文件更新
`public/models/index.json` 成功更新：
- 模型数量: 12个
- 最后更新: 2025-06-19T05:58:22.221Z
- 包含所有模型文件

## 技术细节

### 目录结构分析
```
xiyouji-rela-map/
├── scripts/
│   └── build/
│       └── generate-model-index.js  ← 实际位置
├── public/
│   └── models/
│       ├── index.json               ← 生成的索引
│       └── *.glb                    ← 模型文件
└── package.json                     ← 命令配置
```

### 路径计算
从 `scripts/build/generate-model-index.js` 到 `public/models/`:
- `__dirname` = `scripts/build/`
- `../../public/models` = 正确路径
- `../public/models` = 错误路径（缺少一层）

## 脚本功能验证

### 自动检测功能
- ✅ 扫描 `.glb` 文件
- ✅ 按名称排序
- ✅ 生成完整索引
- ✅ 包含元数据

### 输出格式
```json
{
  "models": ["哪吒.glb", "唐僧.glb", ...],
  "lastUpdated": "2025-06-19T05:58:22.221Z",
  "count": 12,
  "generatedBy": "generate-model-index.js",
  "description": "自动生成的模型文件索引"
}
```

## 使用方法

### 添加新模型后的操作
1. 将 `.glb` 文件放入 `public/models/` 目录
2. 运行 `npm run models:index` 重新生成索引
3. 索引文件自动更新，包含新模型

### 相关命令
- `npm run models:index` - 生成模型索引
- `npm run models:scan` - 扫描模型（同上）
- `npm run models:watch` - 监控模型变化
- `npm run models:test` - 测试模型检测

## 后续优化建议

### 1. 自动化监控
可以考虑添加文件监控，当模型目录有变化时自动重新生成索引。

### 2. 模型验证
可以添加模型文件完整性检查，确保 `.glb` 文件格式正确。

### 3. 缓存优化
可以添加文件修改时间检查，只在有变化时重新生成索引。

## 总结
成功修复了模型索引生成脚本的路径问题，现在用户可以正常添加新模型并自动更新索引。修复包括：
1. 更正 package.json 中的脚本路径
2. 修复脚本内部的相对路径
3. 验证新模型"赛太岁.glb"成功检测

脚本现在可以正常工作，支持自动检测和索引所有模型文件。
