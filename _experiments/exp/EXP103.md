# EXP103: é¼ æ ‡æ‚¬æµ®é»‘å±Bugä¿®å¤

## é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘Šé¼ æ ‡æ‚¬åœåˆ°æ•°æ®ç‚¹æ—¶å‡ºç°é»‘å±ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸¥é‡çš„æ¸²æŸ“é—®é¢˜ã€‚

## æ ¹æœ¬åŸå› åˆ†æ
é€šè¿‡ç¬¬ä¸€æ€§åŸç†åˆ†æå‘ç°é—®é¢˜å‡ºåœ¨useCharacterInteraction Hookä¸­ï¼š

### æ— é™å¾ªç¯é—®é¢˜
```typescript
// é—®é¢˜ä»£ç 
const performRaycast = useCallback(() => {
  // ... å°„çº¿æ£€æµ‹é€»è¾‘
  if (instanceId !== interactionState.hoveredIndex) {
    setInteractionState(prev => ({ ... }))
  }
}, [camera, meshRef, characters, interactionState.hoveredIndex]) // âŒ ä¾èµ–é¡¹åŒ…å«çŠ¶æ€
```

**é—®é¢˜æœºåˆ¶**ï¼š
1. performRaycastæ‰§è¡Œ â†’ æ›´æ–°interactionState.hoveredIndex
2. å› ä¸ºinteractionState.hoveredIndexå˜åŒ–ï¼ŒperformRaycasté‡æ–°åˆ›å»º
3. useFrameæ¯å¸§éƒ½è°ƒç”¨æ–°çš„performRaycast
4. æ— é™å¾ªç¯å¯¼è‡´æ€§èƒ½é—®é¢˜å’Œé»‘å±

## ä¿®å¤æ–¹æ¡ˆ

### 1. ç§»é™¤çŠ¶æ€ä¾èµ–é¡¹
```typescript
// ä¿®å¤åä»£ç 
const performRaycast = useCallback(() => {
  // ä½¿ç”¨å‡½æ•°å¼setStateé¿å…ä¾èµ–å½“å‰çŠ¶æ€
  setInteractionState(prev => {
    if (instanceId !== prev.hoveredIndex) {
      return { ...prev, hoveredIndex: instanceId, ... }
    }
    return prev // çŠ¶æ€æœªå˜åŒ–æ—¶è¿”å›åŸçŠ¶æ€
  })
}, [camera, meshRef, characters]) // âœ… ç§»é™¤çŠ¶æ€ä¾èµ–
```

### 2. æ”¹è¿›æè´¨é…ç½®
```typescript
// CharacterHighlightç»„ä»¶ä¼˜åŒ–
import { DoubleSide } from 'three'

<meshBasicMaterial
  side={DoubleSide} // ä½¿ç”¨å¸¸é‡è€Œéæ•°å­—
  // ... å…¶ä»–å±æ€§
/>
```

### 3. æ·»åŠ é”™è¯¯å¤„ç†
```typescript
useFrame((state) => {
  try {
    // åŠ¨ç”»é€»è¾‘
    const pulseOpacity = Math.max(0.1, 0.3 + Math.sin(pulsePhase.current) * 0.2)
    // ç¡®ä¿å€¼åœ¨åˆç†èŒƒå›´å†…
  } catch (error) {
    console.warn('CharacterHighlight animation error:', error)
  }
})
```

### 4. ä¼˜åŒ–å°„çº¿æ£€æµ‹å‚æ•°
```typescript
// ä¸ºInstancedMeshè®¾ç½®æ­£ç¡®çš„å°„çº¿æ£€æµ‹å‚æ•°
raycaster.current.params.Mesh = { threshold: 0.1 }
raycaster.current.params.Points = { threshold: 0.1 }
```

## ä¿®å¤æ–‡ä»¶
- `src/hooks/useCharacterInteraction.ts` - ä¿®å¤æ— é™å¾ªç¯
- `src/components/three/CharacterHighlight.tsx` - æ”¹è¿›æè´¨å’Œé”™è¯¯å¤„ç†

## æŠ€æœ¯æ”¶è·
1. **React Hookä¾èµ–é¡¹é™·é˜±**: useCallbackä¾èµ–é¡¹ä¸­åŒ…å«ä¼šè¢«å›è°ƒå‡½æ•°ä¿®æ”¹çš„çŠ¶æ€ä¼šå¯¼è‡´æ— é™å¾ªç¯
2. **å‡½æ•°å¼setState**: ä½¿ç”¨prevå‚æ•°è®¿é—®å½“å‰çŠ¶æ€ï¼Œé¿å…åœ¨ä¾èµ–é¡¹ä¸­åŒ…å«çŠ¶æ€
3. **Three.jså°„çº¿æ£€æµ‹**: InstancedMeshéœ€è¦ç‰¹å®šçš„å°„çº¿æ£€æµ‹å‚æ•°é…ç½®
4. **é”™è¯¯å¤„ç†é‡è¦æ€§**: åœ¨åŠ¨ç”»å¾ªç¯ä¸­æ·»åŠ try-catché˜²æ­¢æ¸²æŸ“ä¸­æ–­

## é¢„é˜²æªæ–½
- åœ¨useCallback/useMemoä¾èµ–é¡¹ä¸­é¿å…åŒ…å«ä¼šè¢«å›è°ƒä¿®æ”¹çš„çŠ¶æ€
- ä¼˜å…ˆä½¿ç”¨å‡½æ•°å¼setState
- ä¸ºThree.jsç»„ä»¶æ·»åŠ é”™è¯¯è¾¹ç•Œ
- å®šæœŸæ£€æŸ¥useFrameå¾ªç¯çš„æ€§èƒ½å½±å“

## çŠ¶æ€
âœ… å·²ä¿®å¤é»‘å±é—®é¢˜
âœ… å·²ä¼˜åŒ–æ€§èƒ½
âœ… å·²æ·»åŠ é”™è¯¯å¤„ç†
ğŸ”„ ç­‰å¾…ç”¨æˆ·ç¡®è®¤ä¿®å¤æ•ˆæœ
