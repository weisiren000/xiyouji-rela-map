# EXP103: 鼠标悬浮黑屏Bug修复

## 问题描述
用户报告鼠标悬停到数据点时出现黑屏，这是一个严重的渲染问题。

## 根本原因分析
通过第一性原理分析发现问题出在useCharacterInteraction Hook中：

### 无限循环问题
```typescript
// 问题代码
const performRaycast = useCallback(() => {
  // ... 射线检测逻辑
  if (instanceId !== interactionState.hoveredIndex) {
    setInteractionState(prev => ({ ... }))
  }
}, [camera, meshRef, characters, interactionState.hoveredIndex]) // ❌ 依赖项包含状态
```

**问题机制**：
1. performRaycast执行 → 更新interactionState.hoveredIndex
2. 因为interactionState.hoveredIndex变化，performRaycast重新创建
3. useFrame每帧都调用新的performRaycast
4. 无限循环导致性能问题和黑屏

## 修复方案

### 1. 移除状态依赖项
```typescript
// 修复后代码
const performRaycast = useCallback(() => {
  // 使用函数式setState避免依赖当前状态
  setInteractionState(prev => {
    if (instanceId !== prev.hoveredIndex) {
      return { ...prev, hoveredIndex: instanceId, ... }
    }
    return prev // 状态未变化时返回原状态
  })
}, [camera, meshRef, characters]) // ✅ 移除状态依赖
```

### 2. 改进材质配置
```typescript
// CharacterHighlight组件优化
import { DoubleSide } from 'three'

<meshBasicMaterial
  side={DoubleSide} // 使用常量而非数字
  // ... 其他属性
/>
```

### 3. 添加错误处理
```typescript
useFrame((state) => {
  try {
    // 动画逻辑
    const pulseOpacity = Math.max(0.1, 0.3 + Math.sin(pulsePhase.current) * 0.2)
    // 确保值在合理范围内
  } catch (error) {
    console.warn('CharacterHighlight animation error:', error)
  }
})
```

### 4. 优化射线检测参数
```typescript
// 为InstancedMesh设置正确的射线检测参数
raycaster.current.params.Mesh = { threshold: 0.1 }
raycaster.current.params.Points = { threshold: 0.1 }
```

## 修复文件
- `src/hooks/useCharacterInteraction.ts` - 修复无限循环
- `src/components/three/CharacterHighlight.tsx` - 改进材质和错误处理

## 技术收获
1. **React Hook依赖项陷阱**: useCallback依赖项中包含会被回调函数修改的状态会导致无限循环
2. **函数式setState**: 使用prev参数访问当前状态，避免在依赖项中包含状态
3. **Three.js射线检测**: InstancedMesh需要特定的射线检测参数配置
4. **错误处理重要性**: 在动画循环中添加try-catch防止渲染中断

## 预防措施
- 在useCallback/useMemo依赖项中避免包含会被回调修改的状态
- 优先使用函数式setState
- 为Three.js组件添加错误边界
- 定期检查useFrame循环的性能影响

## 状态
✅ 已修复黑屏问题
✅ 已优化性能
✅ 已添加错误处理
🔄 等待用户确认修复效果
