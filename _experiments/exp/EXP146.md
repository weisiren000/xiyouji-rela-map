# EXP146: 项目基础设施统一化方案制定

## 时间
2025-06-24

## 问题分析

### 当前项目状态
✅ **已解决的问题**：
- 编译错误已从25个减少到0个
- 性能监控系统已恢复
- 模型检测已实现自动化（generate-model-index.js）
- 数据已迁移到SQLite数据库
- 项目可以正常启动运行

❌ **待解决的关键问题**：
1. **包管理器混用**：根目录用pnpm，src/server用npm
2. **数据服务器版本混乱**：存在dataServer.js和dataServer-sqlite.js
3. **脚本命令不一致**：package.json中server命令仍使用npm
4. **架构组织待优化**：文件夹结构需要细粒度组织
5. **自动化与手动处理权衡**：需要明确哪些用自动化，哪些手动处理

## 解决方案设计

### 方案A：渐进式统一（保守方案）
**特点**：分步骤逐个解决，风险最低
**适合**：时间充裕，希望稳妥推进

**执行步骤**：
1. 先统一包管理器（保留现有功能）
2. 再统一数据服务器版本
3. 最后更新脚本命令
4. 单独进行架构优化

**优点**：
- 风险最低，每步都可验证
- 出问题容易回滚
- 符合用户偏好的手动逐步处理

**缺点**：
- 耗时较长
- 中间状态可能存在不一致

### 方案B：一次性重构（激进方案）
**特点**：一次性解决所有问题
**适合**：希望快速解决，接受一定风险

**执行步骤**：
1. 创建新的workspace配置
2. 同时迁移包管理器和数据服务器
3. 批量更新所有脚本命令
4. 同步进行架构优化

**优点**：
- 效率最高
- 最终状态最一致
- 避免中间状态的混乱

**缺点**：
- 风险较高
- 出问题影响面大
- 不符合用户偏好的渐进式处理

### 方案C：混合方案（平衡方案）⭐ 推荐
**特点**：核心问题一次性解决，非核心问题分步处理
**适合**：平衡效率和风险

**执行步骤**：
1. **第一阶段**：统一基础设施（包管理器+数据服务器+脚本）
2. **第二阶段**：架构优化（文件夹组织）
3. **第三阶段**：自动化完善（按需优化）

**优点**：
- 平衡效率和风险
- 核心问题快速解决
- 符合用户的优先级偏好

**缺点**：
- 需要更仔细的规划
- 阶段间需要协调

## 技术实施细节

### 包管理器统一
```bash
# 1. 在根目录添加workspace配置
# 2. 删除src/server/node_modules和package-lock.json
# 3. 将src/server依赖合并到根目录
# 4. 更新pnpm-workspace.yaml
```

### 数据服务器统一
```bash
# 1. 确认dataServer-sqlite.js为主版本
# 2. 重命名为dataServer.js
# 3. 删除旧的JSON版本
# 4. 更新相关引用
```

### 脚本命令更新
```json
{
  "server": "cd src/server && pnpm start",
  "server:dev": "cd src/server && pnpm run dev",
  "install:server": "pnpm install"
}
```

## 风险评估

### 低风险操作
- 更新package.json脚本命令
- 重命名数据服务器文件
- 添加workspace配置

### 中风险操作
- 删除src/server/node_modules
- 合并依赖到根目录
- 架构文件夹重组

### 高风险操作
- 批量移动文件
- 修改大量引用路径

## 建议执行顺序

1. **立即执行**：方案C第一阶段（基础设施统一）
2. **短期执行**：方案C第二阶段（架构优化）
3. **长期规划**：方案C第三阶段（自动化完善）

## 用户偏好适配

- ✅ 提供多个方案选择
- ✅ 优先手动处理而非自动化脚本
- ✅ 分阶段执行，便于控制风险
- ✅ 保持现有良好功能不变
- ✅ 详细的执行步骤说明

## 下一步行动

等待用户选择方案后，立即开始执行对应的实施计划。
