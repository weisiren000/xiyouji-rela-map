# EXP120: 修复角色球体颜色发黑问题

## 问题描述
用户反馈角色球体颜色发黑，都看不到了。经过调试发现是Three.js材质配置问题。

## 问题分析

### 第一性原理分析
1. **核心问题**: 球体显示为黑色，无法看到角色
2. **基础事实**: 
   - 数据服务器正常运行，API返回正确的visual配置
   - 颜色计算逻辑正确，RGB值正常
   - 问题出现在Three.js渲染层面

### 根本原因
通过调试发现问题在于Three.js材质配置错误：

1. **错误的材质设置**:
```javascript
<meshStandardMaterial
  emissive="#000000"
  emissiveIntensity={0}
  vertexColors={true}  // ❌ 错误：我们使用的是实例颜色，不是顶点颜色
/>
```

2. **颜色计算中的透明度错误**:
```javascript
// ❌ 错误：将透明度乘到颜色上会让颜色变暗
const finalOpacity = character.isAlias ? aliasOpacity : opacity
tempColor.multiplyScalar(finalOpacity)
```

## 解决方案

### 1. 修复材质配置
```javascript
<meshStandardMaterial
  metalness={metalness}
  roughness={roughness}
  color="#ffffff"  // ✅ 设置基础白色
  transparent={opacity < 1 || aliasOpacity < 1}
  opacity={opacity}
  // ✅ 移除 vertexColors={true}，因为我们使用实例颜色
/>
```

### 2. 修复颜色计算逻辑
```javascript
if (useOriginalColors && character.visual?.color) {
  tempColor.set(character.visual.color)
  
  // 应用颜色强度和发光增强
  const glowBoost = 1 + emissiveIntensity * 1.5
  tempColor.multiplyScalar(colorIntensity * glowBoost)
  
  // 确保颜色不会过度饱和
  const maxComponent = Math.max(tempColor.r, tempColor.g, tempColor.b)
  if (maxComponent > 1) {
    const scale = 1.0 / maxComponent
    tempColor.multiplyScalar(scale)
  }
} else {
  tempColor.set('#ffffff')
  tempColor.multiplyScalar(colorIntensity)
}

// ✅ 不再将透明度乘到颜色上
meshRef.current!.setColorAt(i, tempColor)
```

## 调试过程

### 1. 数据验证
- 确认数据服务器正常运行（端口3003）
- 验证API返回正确的visual配置
- 检查角色数据包含正确的颜色值（如#FFD700金色）

### 2. 颜色计算验证
通过添加调试信息确认：
```
🎨 角色0 孙悟空:
  - visual对象: {color: #FFD700, size: 1.95, emissiveIntensity: 0.56}
  - 原始颜色: #FFD700
  - 设置后RGB: 1.000 0.680 0.000
  - 增强后RGB: 2.000 1.359 0.000
```

### 3. Three.js配置修复
发现问题在于：
- `vertexColors={true}` 与 `setColorAt()` 冲突
- 材质emissive设置为黑色导致无发光效果

## 技术要点

### InstancedMesh颜色设置
- 使用 `setColorAt(index, color)` 设置实例颜色
- 材质不应设置 `vertexColors={true}`
- 基础材质颜色应为白色，让实例颜色正确显示

### 颜色计算最佳实践
- 透明度不应影响颜色亮度
- 发光增强应适度，避免过度饱和
- 颜色归一化确保RGB值在合理范围内

## 结果
- ✅ 球体颜色正常显示
- ✅ 角色按类型显示不同颜色（金色、蓝色、红色等）
- ✅ 发光效果正常工作
- ✅ 482个球体（150角色+332别名）全部正确渲染

## 经验总结
1. **第一性原理思考**: 从基础的Three.js渲染原理出发分析问题
2. **系统性调试**: 从数据→计算→渲染逐层验证
3. **材质配置重要性**: InstancedMesh的材质配置需要与实例属性设置匹配
4. **透明度与颜色分离**: 透明度应在材质层面处理，不应影响颜色计算

## 文件修改
- `src/components/three/CharacterSpheresSimple.tsx`: 修复材质配置和颜色计算逻辑
