# EXP105: 端口自动检测和适应性增强

## 时间
2025-06-17

## 问题描述
用户反馈"后端开了，但是没匹配上，现在需要加强端口的适应性，自动检测匹配端口"

## 第一性原理分析

### 核心问题
- 前端和后端端口配置不一致导致连接失败
- 缺乏动态端口发现机制
- 端口冲突时没有自动适应能力

### 基础事实
- 后端服务器在端口3003运行
- 前端API配置硬编码为端口3002
- 部分组件还在使用端口3001
- 需要一个统一的端口检测和适应机制

## 解决方案实施

### 1. 前端API服务增强
**文件**: `src/services/dataApi.ts`

**核心改进**:
- 添加端口检测函数 `detectBackendPort()`
- 支持多端口自动扫描 `[3003, 3002, 3001, 3000, 8080, 8000]`
- 实现自动重试机制
- 提供手动端口设置功能

**关键特性**:
```typescript
// 自动端口检测
async function detectBackendPort(): Promise<number | null>

// 带重试的API请求
async function apiRequest<T>(endpoint: string, options?: RequestInit): Promise<T>

// 连接状态检查
static async checkConnection(): Promise<boolean>
```

### 2. 组件更新
**更新的组件**:
- `src/components/three/CharacterSpheres.tsx` - 使用DataApi替代硬编码URL
- `src/components/ui/CharacterDataPanel.tsx` - 统一使用DataApi服务

**类型定义更新**:
- `src/types/character.ts` - 更新DataStats接口匹配后端数据结构

### 3. 端口状态指示器
**新组件**: `src/components/ui/PortStatusIndicator.tsx`

**功能**:
- 实时显示后端连接状态
- 显示当前使用的端口号
- 提供手动端口配置界面
- 自动重新检测功能

**集成位置**: 主应用右上角显示

### 4. 智能启动脚本
**新脚本**:
- `scripts/start-with-auto-port.bat` - Windows批处理版本
- `scripts/start-with-auto-port.ps1` - PowerShell增强版本

**功能特性**:
- 自动检测可用端口
- 动态更新后端配置
- 依赖检查和安装
- 服务启动状态验证
- 前后端协调启动

**使用方法**:
```bash
# PowerShell版本（推荐）
pnpm run start:auto

# 详细输出版本
pnpm run start:auto:verbose

# 批处理版本
pnpm run start:auto:bat
```

## 技术实现细节

### 端口检测算法
1. **优先级端口列表**: [3003, 3002, 3001, 3000, 8080, 8000]
2. **检测方法**: HTTP HEAD请求到 `/api/stats` 端点
3. **超时设置**: 2秒超时，避免长时间等待
4. **重试机制**: API请求失败时自动重新检测

### 错误处理策略
- **网络错误**: 自动重试其他端口
- **服务器错误**: 显示详细错误信息
- **超时处理**: 优雅降级到默认配置
- **用户反馈**: 实时状态显示和错误提示

### 性能优化
- **缓存机制**: 检测成功后缓存端口信息
- **定期检查**: 30秒间隔检查连接状态
- **按需检测**: 只在必要时进行端口扫描

## 配置更新

### package.json新增脚本
```json
{
  "start:auto": "powershell -ExecutionPolicy Bypass -File scripts/start-with-auto-port.ps1",
  "start:auto:verbose": "powershell -ExecutionPolicy Bypass -File scripts/start-with-auto-port.ps1 -Verbose",
  "start:auto:bat": "scripts/start-with-auto-port.bat"
}
```

### 类型定义更新
```typescript
export interface DataStats {
  totalCharacters: number
  totalAliases: number
  charactersByType: Record<string, number>
  charactersByFaction: Record<string, number>
  charactersByCategory: Record<string, number>
  powerDistribution: {
    high: number
    medium: number
    low: number
  }
  relationshipCount?: number
  lastUpdated: string
}
```

## 用户体验改进

### 1. 可视化状态指示
- 右上角端口状态指示器
- 颜色编码：绿色(连接)、红色(失败)、橙色(检测中)
- 点击可手动重新检测

### 2. 智能启动流程
- 一键启动命令
- 自动依赖检查
- 端口冲突自动解决
- 启动状态实时反馈

### 3. 错误恢复能力
- API请求失败自动重试
- 端口变更自动适应
- 详细错误信息显示

## 测试验证

### 端口检测测试
- ✅ 多端口扫描功能
- ✅ 超时处理机制
- ✅ 错误恢复能力
- ✅ 缓存机制有效性

### 组件集成测试
- ✅ CharacterSpheres数据加载
- ✅ CharacterDataPanel统计显示
- ✅ PortStatusIndicator状态显示
- ✅ 主应用界面集成

### 启动脚本测试
- ✅ 依赖检查功能
- ✅ 端口检测和配置
- ✅ 服务启动协调
- ✅ 错误处理和反馈

## 结果评估

### 解决的问题
1. ✅ 端口不匹配问题完全解决
2. ✅ 自动检测机制工作正常
3. ✅ 用户体验显著改善
4. ✅ 错误处理更加健壮

### 技术收益
- **可维护性**: 统一的API服务管理
- **可靠性**: 自动错误恢复机制
- **用户友好**: 可视化状态指示
- **开发效率**: 一键启动脚本

### 未来扩展
- 支持更多后端服务发现协议
- 添加服务健康检查功能
- 实现负载均衡和故障转移
- 支持配置文件持久化

## 状态
✅ 端口自动检测机制实现完成
✅ 前端组件全部更新
✅ 智能启动脚本开发完成
✅ 用户界面状态指示器集成
🎯 系统适应性和健壮性显著提升
