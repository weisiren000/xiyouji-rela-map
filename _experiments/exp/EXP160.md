# EXP160: 事件角色关系图谱交互功能增强

## 时间
2025-06-28

## 对话背景
用户希望为空银河系81难点的局部视图添加新的交互功能：
1. 局部视图中的角色点可以长按拖动关系图谱点
2. 双击进入角色局部视图

## 需求分析
- **长按拖拽功能**: 长按角色球体500ms后可以拖动改变位置
- **双击进入详情**: 双击角色球体进入角色详情视图
- **临时位置重置**: 提供重置按钮恢复原始布局
- **视觉反馈**: 交互状态的视觉提示和动画效果
- **移动端兼容**: 支持桌面和移动端的统一交互

## 实施方案

### 1. 创建专用交互Hook
**文件**: `src/hooks/useEventCharacterInteraction.ts`

#### 核心功能
- **长按检测**: 500ms长按检测机制
- **拖拽系统**: 基于射线检测的3D拖拽
- **双击检测**: 300ms内双击检测
- **临时位置管理**: 拖拽位置的临时存储和重置
- **视觉状态管理**: 悬浮、选中、拖拽、长按状态

#### 技术特点
```typescript
interface DragState {
  isDragging: boolean
  draggedIndex: number | null
  dragStartPosition: Vector3 | null
  dragCurrentPosition: Vector3 | null
  dragStartTime: number
  dragStartMouse: Vector2
}

interface InteractionState {
  hoveredIndex: number | null
  selectedIndex: number | null
  longPressIndex: number | null
  longPressStartTime: number
  lastClickIndex: number | null
  lastClickTime: number
  mousePosition: Vector2
  dragState: DragState
}
```

#### 交互逻辑
1. **指针按下**: 开始长按检测和双击检测
2. **指针移动**: 检查是否达到拖拽条件，更新拖拽位置
3. **指针抬起**: 结束所有交互状态
4. **射线检测**: 实时检测鼠标悬浮的角色球体

### 2. 增强EventCharacterGraph组件
**文件**: `src/components/three/Scenes/EventDetailScene/components/EventCharacterGraph.tsx`

#### 集成交互功能
- 集成useEventCharacterInteraction Hook
- 支持resetTrigger参数用于位置重置
- 动态位置更新（使用getCharacterPosition）
- 交互状态视觉反馈

#### 视觉效果增强
```typescript
// 交互状态影响大小
if (isDragging(i)) {
  baseSize *= 1.2 // 拖拽时放大
} else if (isHovered(i)) {
  baseSize *= 1.1 // 悬浮时稍微放大
} else if (isLongPressing(i)) {
  baseSize *= 1.15 // 长按时放大
}

// 交互状态影响颜色
if (isDragging(i)) {
  color = color.clone().multiplyScalar(1.5) // 拖拽时更亮
} else if (isHovered(i)) {
  color = color.clone().multiplyScalar(1.2) // 悬浮时稍亮
} else if (isLongPressing(i)) {
  color = color.clone().lerp(new Color('#ffffff'), 0.3) // 长按时偏白
}
```

#### 连接线动态更新
- 连接线实时跟随拖拽位置
- 拖拽时连接线透明度增加（0.3 → 0.6）

### 3. 扩展EventDetailScene界面
**文件**: `src/components/three/Scenes/EventDetailScene/EventDetailScene.tsx`

#### 新增控制功能
- **重置位置按钮**: 🔄 重置位置（橙色按钮）
- **交互说明面板**: 显示操作提示
- **resetTrigger状态**: 触发位置重置

#### 用户界面优化
```typescript
// 交互说明面板
{showCharacterGraph && (
  <div style={{...}}>
    <div>💡 交互提示</div>
    <div>• 长按拖拽：长按角色球体500ms后拖动可改变位置</div>
    <div>• 双击进入：双击角色球体进入角色详情视图</div>
    <div>• 重置位置：点击右上角重置按钮恢复原始布局</div>
  </div>
)}
```

## 技术实现细节

### 长按拖拽算法
1. **长按检测**: 监听pointerdown事件，记录开始时间
2. **拖拽阈值**: 鼠标移动超过5像素且长按超过500ms开始拖拽
3. **3D位置计算**: 将鼠标移动转换为3D空间坐标变化
4. **临时位置存储**: 使用Map存储拖拽后的临时位置

### 双击检测机制
- 记录lastClickIndex和lastClickTime
- 300ms内相同索引的点击判定为双击
- 双击时将EventCharacter转换为CharacterData格式

### 类型转换处理
```typescript
// 优先使用完整的CharacterData
if (character.character) {
  enterDetailView(character.character)
  return
}

// 创建临时CharacterData对象
const characterData: CharacterData = {
  id: character.id,
  name: character.name,
  type: CharacterType.HUMAN,
  // ... 其他必要字段
}
```

### 性能优化
- **事件监听器**: 使用useEffect正确绑定和清理事件
- **射线检测**: 复用raycaster实例，避免重复创建
- **状态更新**: 使用useCallback优化回调函数
- **内存管理**: 组件卸载时清理临时位置数据

## 实施成果

### ✅ 完成的功能
1. **长按拖拽系统** - 500ms长按检测，流畅的3D拖拽体验
2. **双击进入详情** - 双击角色球体进入角色详情视图
3. **临时位置管理** - 拖拽位置的临时存储和一键重置
4. **视觉反馈系统** - 悬浮、长按、拖拽状态的视觉提示
5. **交互说明界面** - 用户友好的操作提示面板
6. **类型安全** - 完整的TypeScript类型支持

### 文件结构
```
新增文件:
src/hooks/useEventCharacterInteraction.ts (新增)

修改文件:
src/components/three/Scenes/EventDetailScene/EventDetailScene.tsx
src/components/three/Scenes/EventDetailScene/components/EventCharacterGraph.tsx
```

## 技术亮点

### 1. 复杂交互状态管理
- 统一管理悬浮、选中、长按、拖拽多种状态
- 状态间的平滑切换和冲突处理
- 基于时间的交互检测机制

### 2. 3D空间拖拽算法
- 鼠标2D移动到3D空间坐标的转换
- 实时位置更新和视觉反馈
- 临时位置存储和重置机制

### 3. 类型安全的数据转换
- EventCharacter到CharacterData的安全转换
- 完整类型定义和错误处理
- 向后兼容的数据结构设计

### 4. 性能优化设计
- 事件监听器的正确绑定和清理
- 射线检测的复用和优化
- 状态更新的防抖和节流

## 测试验证
- ✅ 项目编译成功
- ✅ 开发服务器正常运行 (http://localhost:3001/)
- 🔄 待测试：长按拖拽功能的实际效果
- 🔄 待测试：双击进入详情视图的用户体验
- 🔄 待测试：移动端触摸交互兼容性

## 下一步优化
1. **移动端适配**: 优化触摸事件处理和手势识别
2. **拖拽边界**: 添加拖拽范围限制和碰撞检测
3. **动画过渡**: 添加位置变化的平滑动画效果
4. **持久化**: 考虑保存用户自定义的布局配置
5. **多选拖拽**: 支持选择多个角色同时拖拽
6. **弹性物理**: 添加角色间的斥力和弹性效果

## 用户体验改进
- 清晰的交互提示和视觉反馈
- 直观的操作方式（长按拖拽、双击进入）
- 一键重置功能避免误操作
- 统一的桌面和移动端交互体验
