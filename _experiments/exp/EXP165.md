# EXP165: 事件局部视图关系图谱线条实时跟随优化

## 时间
2025-06-28

## 对话背景
用户需要让事件局部视图的关系图谱的线条实时跟随拖动球体移动，包括浮动动画效果。

## 问题分析
原有实现中存在的问题：
1. **连接线更新机制不完善**: `ConnectionLine` 组件使用 `useMemo` 缓存点位置，但 `bufferAttribute` 的数组一旦创建就不会自动更新
2. **浮动效果不同步**: 球体在 `useFrame` 中有浮动效果，但连接线使用的是基础位置，没有包含浮动效果
3. **实时性不足**: 拖拽时连接线无法完全跟随球体的实时位置变化

## 解决方案

### 1. 优化 ConnectionLine 组件
**文件**: `src/components/three/Scenes/EventDetailScene/components/EventCharacterGraph.tsx`

**关键改进**:
- 添加 `geometryRef` 引用 BufferGeometry
- 使用 `useEffect` 监听 `start` 和 `end` 参数变化
- 实时更新 `bufferAttribute` 的位置数组
- 设置 `needsUpdate = true` 强制更新几何体

```typescript
const ConnectionLine: React.FC<ConnectionLineProps> = ({
  start, end, color, opacity = 0.5
}) => {
  const geometryRef = useRef<BufferGeometry>(null)
  
  // 使用 useEffect 来实时更新线条位置
  useEffect(() => {
    if (geometryRef.current) {
      const positions = new Float32Array([
        start[0], start[1], start[2],
        end[0], end[1], end[2]
      ])
      
      geometryRef.current.setAttribute('position', new BufferAttribute(positions, 3))
      geometryRef.current.attributes.position.needsUpdate = true
    }
  }, [start, end])
  
  // ... 渲染逻辑
}
```

### 2. 实现实时位置跟踪
**新增功能**:
- 添加 `realTimePositions` ref 存储包含浮动效果的实时球体位置
- 在 `useFrame` 中更新实时位置数组
- 创建 `getRealTimePosition` 函数获取实时位置
- 连接线渲染时使用实时位置而非基础位置

**核心代码**:
```typescript
// 存储实时球体位置（包含浮动效果）
const realTimePositions = useRef<Vector3[]>([])

// 在 useFrame 中存储实时位置
const floatIntensity = isDragging(i) ? 0.1 : 0.3
tempObject.position.y += Math.sin(time * 2 + i * 0.5) * floatIntensity

// 存储实时位置（包含浮动效果）
if (!realTimePositions.current[i]) {
  realTimePositions.current[i] = new Vector3()
}
realTimePositions.current[i].copy(tempObject.position)

// 获取实时位置的函数
const getRealTimePosition = useCallback((index: number): Vector3 => {
  if (realTimePositions.current[index]) {
    return realTimePositions.current[index]
  }
  return getCharacterPosition(index)
}, [getCharacterPosition])
```

### 3. 连接线渲染优化
**修改连接线渲染逻辑**:
```typescript
{/* 连接线（从中心到各个角色） */}
{characters.map((character, index) => {
  const currentPosition = getRealTimePosition(index) // 使用实时位置
  return (
    <ConnectionLine
      key={character.id}
      start={[0, 0, 0]}
      end={[currentPosition.x, currentPosition.y, currentPosition.z]}
      color={character.color}
      opacity={isDragging(index) ? 0.6 : 0.3}
    />
  )
})}
```

## 技术要点

### 1. BufferGeometry 实时更新
- 使用 `setAttribute` 方法更新位置属性
- 设置 `needsUpdate = true` 触发重新渲染
- 避免每次都创建新的几何体，提高性能

### 2. 位置同步机制
- 球体位置 = 基础位置 + 拖拽偏移 + 浮动效果
- 连接线终点 = 球体的实时位置（包含所有效果）
- 确保视觉一致性

### 3. 性能优化
- 使用 `useCallback` 缓存函数
- 复用 Vector3 对象避免频繁创建
- 只在必要时更新几何体属性

## 实现效果
1. ✅ 连接线完全跟随球体拖拽移动
2. ✅ 连接线同步球体浮动动画效果
3. ✅ 拖拽时连接线透明度增加，视觉反馈更明显
4. ✅ 性能优化，避免不必要的重新渲染

## 测试验证
- 项目成功启动在 http://localhost:3001
- Vite 热更新正常工作
- 代码编译无错误
- 需要在浏览器中测试实际拖拽效果

## 后续优化建议
1. 可以考虑添加连接线的弹性动画效果
2. 优化大量角色时的性能表现
3. 添加连接线的视觉样式选项（虚线、渐变等）
