# EXP167: 事件关系图谱GUI面板收起Bug修复

## 时间
2025-06-28

## 问题描述
用户报告在事件局部视图的球体属性渲染GUI中，只要调整任何参数，GUI面板就会自动全盘收起，导致用户体验很差。

## 问题分析

### 根本原因
GUI面板在参数变化时会重新创建，导致面板收起。具体原因：

1. **useEffect依赖项问题**: 
   ```typescript
   useEffect(() => {
     // GUI创建逻辑
   }, [visible, eventCharacterGraphConfig, updateEventCharacterGraphConfig])
   ```
   依赖项中包含了 `eventCharacterGraphConfig`，每次配置变化时都会触发useEffect重新执行

2. **GUI重新创建**: 
   每次配置变化 → useEffect重新执行 → GUI销毁并重新创建 → 面板重置为收起状态

3. **状态丢失**: 
   用户展开的文件夹状态在GUI重新创建时丢失

## 解决方案

### 1. 修复useEffect依赖项
**问题代码**:
```typescript
useEffect(() => {
  // GUI创建逻辑
}, [visible, eventCharacterGraphConfig, updateEventCharacterGraphConfig])
```

**修复后**:
```typescript
useEffect(() => {
  // GUI创建逻辑
}, [visible]) // 只依赖 visible，避免配置变化时重新创建GUI
```

### 2. 添加初始化控制
**新增初始化标志**:
```typescript
const isInitializedRef = useRef(false)

useEffect(() => {
  if (!containerRef.current || !visible || isInitializedRef.current) return
  
  // 标记为已初始化
  isInitializedRef.current = true
  
  // GUI创建逻辑
}, [visible])
```

### 3. 正确的清理机制
**清理函数修复**:
```typescript
return () => {
  gui.destroy()
  isInitializedRef.current = false // 重置初始化标志
}
```

**可见性变化处理**:
```typescript
// 当不可见时重置初始化标志
useEffect(() => {
  if (!visible) {
    isInitializedRef.current = false
  }
}, [visible])
```

### 4. 预设应用优化
**简化预设应用逻辑**:
```typescript
const presetController = {
  preset: 'default',
  applyPreset: () => {
    const selectedPreset = EVENT_CHARACTER_GRAPH_PRESETS[presetController.preset]
    if (selectedPreset) {
      updateEventCharacterGraphConfig(selectedPreset.config)
      // 移除GUI重新创建逻辑，让参数自然更新
    }
  }
}
```

## 技术要点

### 1. React useEffect 最佳实践
- **最小依赖原则**: 只包含真正需要的依赖项
- **避免过度重新渲染**: 不要将会频繁变化的状态作为依赖项
- **正确的清理**: 确保在组件卸载时正确清理资源

### 2. GUI状态管理
- **初始化控制**: 使用ref标志控制初始化时机
- **状态持久化**: 避免不必要的GUI重新创建
- **生命周期管理**: 正确处理组件的挂载和卸载

### 3. lil-gui 使用模式
- **一次性创建**: GUI实例应该只创建一次
- **参数绑定**: 通过onChange回调更新状态，而不是重新创建GUI
- **内存管理**: 确保在组件卸载时销毁GUI实例

## 修复验证

### 修复前行为
1. 用户展开GUI面板的某个文件夹
2. 调整任意参数
3. GUI面板立即全部收起
4. 用户需要重新展开文件夹才能继续调整

### 修复后行为
1. 用户展开GUI面板的某个文件夹
2. 调整任意参数
3. GUI面板保持展开状态
4. 用户可以继续调整其他参数

## 相关文件修改

### 主要修改
- `src/components/controls/EventCharacterGraphGUI/EventCharacterGraphGUI.tsx`
  - 修复useEffect依赖项
  - 添加初始化控制逻辑
  - 优化清理机制

### 类型定义修复
- `src/stores/useGalaxyStore.ts`
  - 添加 `updateEventCharacterGraphConfig` 方法的类型定义

## 后续优化建议

1. **状态持久化**: 考虑保存用户的GUI面板展开状态
2. **性能优化**: 避免不必要的GUI重新渲染
3. **用户体验**: 添加参数变化的视觉反馈
4. **错误处理**: 增加GUI创建失败的错误处理

## 经验总结

1. **GUI组件设计**: 避免在状态变化时重新创建整个GUI
2. **React Hook使用**: 仔细考虑useEffect的依赖项
3. **用户体验**: 保持UI状态的连续性是良好用户体验的关键
4. **调试技巧**: 通过日志和断点确认问题的根本原因
