# EXP156 - 事件信息卡片系统重构：从角色数据到81难事件数据

## 任务背景

用户反馈空银河系页面中的信息卡片显示的是角色相关数据（战力、影响力、综合排名等），这些对于事件来说没有意义。需要将信息卡片系统重构为显示事件相关的有用信息，如事件描述、相关角色、寓意等。

## 分析思路

1. 当前问题分析：
   - JourneyPoints组件使用CharacterInfoStore显示角色数据
   - 信息卡片显示战力、影响力、排名等角色属性
   - 对于81难事件，这些数据没有意义

2. 解决方案设计：
   - 创建专门的事件信息卡片组件
   - 建立事件信息状态管理系统
   - 修改JourneyPoints组件使用事件数据
   - 更新页面组件使用新的事件信息系统

## 实施过程

### 1. 创建事件信息卡片组件

创建 `EventInfoCard.tsx` 组件，专门用于显示81难事件信息：

```typescript
// src/components/panels/EventInfoCard/EventInfoCard.tsx
interface EventInfoCardProps {
  event: EventData | null
  mousePosition: Vector2
  visible: boolean
}

// 显示内容：
- 事件名称（nanming）
- 难次（nanci）
- 主要人物（zhuyaorenwu）
- 发生地点（didian）
- 事件描述（shijianmiaoshu）
- 象征意义（xiangzhengyi）
- 文化内涵（wenhuaneihan）
```

### 2. 创建事件信息覆盖组件

创建 `EventInfoOverlay.tsx` 组件，类似于CharacterInfoOverlay但专门用于事件：

```typescript
// src/components/indicators/EventInfoOverlay/EventInfoOverlay.tsx
- 包含动画效果和响应式布局
- 根据难次生成渐变颜色（蓝色→紫色→金色）
- 显示取经进度条
- 优化的文本截断和布局
```

### 3. 创建事件信息状态管理

创建 `useEventInfoStore.ts`，管理事件相关的状态：

```typescript
// src/stores/useEventInfoStore.ts
interface EventInfoState {
  hoveredEvent: EventData | null
  mousePosition: Vector2
  showInfoCard: boolean
  
  setHoveredEvent: (event: EventData | null) => void
  setMousePosition: (position: Vector2) => void
  setShowInfoCard: (show: boolean) => void
  clearHover: () => void
}
```

### 4. 修改JourneyPoints组件

重构JourneyPoints组件使用事件信息系统：

```typescript
// 替换导入
- import { useCharacterInfoStore } from '@stores/useCharacterInfoStore'
+ import { useEventInfoStore } from '@stores/useEventInfoStore'

// 修改状态管理
- const { setHoveredCharacter, setShowInfoCard } = useCharacterInfoStore()
+ const { setHoveredEvent, setShowInfoCard, setMousePosition } = useEventInfoStore()

// 修改悬停处理逻辑
const handlePointHover = (index: number) => {
  const journeyPoint = points[index]
  if (journeyPoint.eventData) {
    setHoveredEvent(journeyPoint.eventData)
  } else {
    // 创建临时事件对象
    const tempEvent = {
      id: index + 1,
      nanci: index + 1,
      nanming: journeyPoint.difficulty || `第${index + 1}难`,
      // ... 其他字段
    }
    setHoveredEvent(tempEvent)
  }
}
```

### 5. 更新页面组件

修改EmptyGalaxyPage使用新的事件信息系统：

```typescript
// src/pages/EmptyGalaxyPage.tsx
- import { CharacterInfoOverlay } from '@components/indicators/CharacterInfoOverlay'
- import { useCharacterInfoStore } from '@/stores/useCharacterInfoStore'
+ import { EventInfoOverlay } from '@components/indicators/EventInfoOverlay'
+ import { useEventInfoStore } from '@/stores/useEventInfoStore'

// 更新状态和组件使用
- const { hoveredCharacter, mousePosition, showInfoCard } = useCharacterInfoStore()
+ const { hoveredEvent, mousePosition, showInfoCard } = useEventInfoStore()

- <CharacterInfoOverlay character={hoveredCharacter} ... />
+ <EventInfoOverlay event={hoveredEvent} ... />
```

## 关键技术

1. **组件设计模式**：
   - 保持与现有CharacterInfoCard相似的API设计
   - 使用相同的定位和动画逻辑
   - 适配EventData类型的数据结构

2. **状态管理重构**：
   - 创建独立的事件信息状态管理
   - 保持与角色信息状态管理相同的接口模式
   - 确保状态隔离和类型安全

3. **数据适配**：
   - 处理真实事件数据和临时事件数据
   - 提供fallback机制确保组件稳定性
   - 正确映射EventData字段到UI显示

4. **视觉设计**：
   - 根据难次生成渐变颜色主题
   - 添加取经进度指示器
   - 优化信息层次和可读性

## 解决的问题

1. **信息相关性**：
   - 移除了无意义的角色属性（战力、影响力、排名）
   - 显示与事件相关的有用信息
   - 提供更好的用户体验

2. **数据一致性**：
   - 确保显示的数据与悬浮的对象类型一致
   - 避免类型混淆和数据错误

3. **功能完整性**：
   - 保持所有原有的交互功能
   - 添加事件特有的信息展示
   - 维持系统的稳定性

## 经验总结

1. **组件重构策略**：
   - 创建新组件而不是修改现有组件，保持系统稳定
   - 保持相似的API设计，降低集成复杂度
   - 逐步替换，确保每个步骤都可以验证

2. **状态管理设计**：
   - 为不同类型的数据创建独立的状态管理
   - 保持接口一致性，便于组件切换
   - 确保类型安全和状态隔离

3. **用户体验优化**：
   - 显示与上下文相关的信息
   - 提供视觉层次和信息组织
   - 保持交互的一致性和流畅性

4. **代码组织**：
   - 按功能模块组织代码结构
   - 保持命名的一致性和可读性
   - 添加适当的类型定义和文档

## 改进空间

1. **数据丰富性**：
   - 可以添加更多事件相关信息
   - 支持事件之间的关联显示
   - 添加历史背景和文化解读

2. **交互增强**：
   - 添加点击查看详情功能
   - 支持事件搜索和筛选
   - 提供事件时间线视图

3. **性能优化**：
   - 优化大量事件数据的渲染性能
   - 实现虚拟滚动和懒加载
   - 缓存事件数据和计算结果

## 技术债务

1. 需要确保所有相关组件都更新到新的事件信息系统
2. 考虑是否需要保留角色信息系统用于其他页面
3. 统一事件数据的获取和缓存策略
