# MEM124 - 局部视图模型特效系统架构记忆

## 核心架构设计

### 模型系统组件层次
```
ModelSystem (统一入口)
├── ModelLoader (模型加载)
├── ModelEffectRenderer (特效渲染)
└── ModelEffectGUI (调试面板)
```

### 条件渲染逻辑
- **模型存在** → 显示ModelEffectRenderer（线框+点特效）
- **模型不存在** → 显示fallbackSphere（原始球体）
- **加载中** → 显示加载指示器

### Shader特效系统
- **点特效**: vertexShader + fragmentShader
- **线框特效**: edgeVertexShader + edgeFragmentShader  
- **噪声函数**: fbm、snoise实现动态效果
- **脉冲动画**: 多点脉冲和波纹扩散
- **颜色系统**: 4种调色板，HSL颜色变化

### GUI参数分组
1. **全局设置**: 显示控制、调色板选择
2. **点特效**: 大小、亮度、透明度
3. **线框特效**: 亮度、透明度
4. **动画参数**: 脉冲强度、速度、旋转
5. **模型变换**: 缩放、三轴旋转控制

## 关键技术实现

### 模型数据提取
```typescript
// 从GLB模型提取顶点和边
model.traverse((child) => {
  if (child.isMesh && child.geometry) {
    // 提取顶点位置
    // 从索引创建三角形边
    // 转换到世界坐标
  }
})
```

### 特效材质创建
```typescript
// 点特效材质
new THREE.ShaderMaterial({
  uniforms: pointsUniforms,
  vertexShader, fragmentShader,
  transparent: true,
  blending: THREE.AdditiveBlending
})
```

### 配置驱动系统
```typescript
interface ModelEffectConfig {
  showWireframe: boolean
  showPoints: boolean
  activePaletteIndex: number
  pointSize: number
  // ... 更多参数
}
```

## 文件路径约定
- **模型文件**: `public/models/{characterName}.glb`
- **已知模型**: sun_wu_kong, 孙悟空
- **Shader代码**: `src/components/three/shaders/`
- **GUI组件**: `src/components/ui/`

## 集成点
- **局部视图**: CharacterDetailScene.tsx
- **交互触发**: useCharacterInteraction hook
- **状态管理**: useGalaxyStore (enterDetailView)
- **条件渲染**: App.tsx (viewMode切换)

## 性能优化策略
- **InstancedMesh**: 批量渲染优化
- **AdditiveBlending**: 特效混合模式
- **depthWrite: false**: 透明度优化
- **frustumCulled**: 视锥体剔除

## 扩展性设计
- **模型检测**: 可扩展已知模型列表
- **Shader参数**: 通过uniform动态控制
- **GUI预设**: localStorage保存/加载
- **颜色主题**: 可添加更多调色板

## 错误处理机制
- **模型加载失败** → 回退到球体渲染
- **Shader编译错误** → 使用基础材质
- **GUI初始化失败** → 隐藏调试面板
- **参数验证** → 边界值检查和默认值

## 用户交互流程
1. **银河系视图** → 点击角色球体
2. **触发enterDetailView** → 切换到detail模式
3. **ModelSystem检测** → 模型存在性判断
4. **条件渲染** → 特效或球体显示
5. **GUI调试** → 实时参数调整
6. **返回按钮** → 回到银河系视图

这个架构为后续3D模型功能开发提供了完整的基础框架。
