# MEM161: 事件关系图谱连接线实时跟随技术实现

## 核心技术记忆

### 1. BufferGeometry 实时更新模式
- **问题**: Three.js BufferGeometry 的 bufferAttribute 创建后不会自动更新
- **解决**: 使用 useEffect + geometryRef 手动更新位置属性
- **关键代码**: `geometryRef.current.setAttribute('position', new BufferAttribute(positions, 3))`
- **触发更新**: `geometryRef.current.attributes.position.needsUpdate = true`

### 2. 实时位置同步机制
- **球体位置组成**: 基础位置 + 拖拽偏移 + 浮动动画效果
- **存储策略**: 使用 `realTimePositions` ref 存储完整的实时位置
- **更新时机**: 在 useFrame 中每帧更新位置数组
- **获取方式**: `getRealTimePosition` 函数统一获取实时位置

### 3. 连接线组件优化模式
```typescript
const ConnectionLine = ({ start, end, color, opacity }) => {
  const geometryRef = useRef<BufferGeometry>(null)
  
  useEffect(() => {
    if (geometryRef.current) {
      const positions = new Float32Array([start[0], start[1], start[2], end[0], end[1], end[2]])
      geometryRef.current.setAttribute('position', new BufferAttribute(positions, 3))
      geometryRef.current.attributes.position.needsUpdate = true
    }
  }, [start, end])
}
```

### 4. 性能优化要点
- **避免频繁创建**: 复用 Vector3 对象和 BufferAttribute
- **函数缓存**: 使用 useCallback 缓存位置获取函数
- **条件更新**: 只在位置真正变化时更新几何体
- **引用复用**: 使用 ref 存储位置数组避免重新分配

## 应用场景记忆
- **适用**: 需要连接线跟随3D对象实时移动的场景
- **典型用例**: 关系图谱、节点连接、动态网络可视化
- **扩展性**: 可用于任何需要动态更新几何体的Three.js应用

## 调试经验
- **导入问题**: 需要正确导入 BufferAttribute, BufferGeometry 类型
- **更新标志**: 必须设置 needsUpdate = true 才能触发重新渲染
- **位置同步**: 确保连接线使用的位置与球体渲染位置完全一致
- **热更新**: Vite 热更新对 Three.js 组件修改响应良好
