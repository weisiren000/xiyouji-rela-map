# MEM128 - SQLite数据迁移完整实施技术记忆

## 核心技术实施记忆

### 数据迁移完整流程
**第一阶段 - 环境准备**:
- 项目使用pnpm包管理器，不是npm
- 需要安装better-sqlite3依赖: `pnpm add better-sqlite3`
- 必须批准构建脚本才能正常使用SQLite
- 自动备份原始JSON数据到`data/backup/`目录

**第二阶段 - 角色数据迁移**:
- 创建`scripts/data-migration/migrate-fixed.cjs`脚本
- 处理150个角色JSON文件，100%成功迁移
- 数据库文件: `data/characters.db` (初始0.13MB)
- 创建6个性能优化索引

**第三阶段 - 别名数据补充**:
- 发现遗漏了`character_alias`目录的332个别名文件
- 创建`scripts/data-migration/migrate-aliases.cjs`脚本
- 成功迁移332个别名，建立正确的关联关系
- 最终数据库: 482条记录 (150角色 + 332别名)，0.43MB

### 关键技术问题与解决方案

#### ES模块兼容性问题
```javascript
// 问题: 项目配置为ES模块，require语法不兼容
// 解决: 使用.cjs扩展名，采用CommonJS语法
const Database = require('better-sqlite3');
const fs = require('fs');
const path = require('path');
```

#### SQLite数据类型处理
```javascript
// 问题: 布尔值绑定参数错误
// 解决: 转换布尔值为整数
is_alias: jsonData.isAlias ? 1 : 0  // true → 1, false → 0
```

#### 数据库事务中的异步处理
```javascript
// 问题: 事务不支持异步操作
// 解决: 先读取所有数据，再在事务中同步处理
const allData = [];
for (const fileName of jsonFiles) {
  const fileContent = fs.readFileSync(filePath, 'utf-8');
  allData.push({ fileName, jsonData: JSON.parse(fileContent) });
}

const transaction = db.transaction(() => {
  // 同步处理所有数据
});
```

### 数据库设计架构

#### 表结构设计
```sql
-- 角色基础信息表
CREATE TABLE characters (
  unid TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  pinyin TEXT NOT NULL,
  type TEXT NOT NULL,
  category TEXT NOT NULL,
  rank INTEGER,
  power INTEGER,
  influence INTEGER,
  morality TEXT,
  first_appearance INTEGER,
  is_alias INTEGER DEFAULT 0,
  alias_of TEXT
);

-- 角色扩展信息表
CREATE TABLE character_metadata (
  unid TEXT PRIMARY KEY,
  aliases TEXT,           -- JSON格式存储
  tags TEXT,             -- JSON格式存储
  source_chapters TEXT,   -- JSON格式存储
  attributes TEXT,        -- JSON格式存储
  description TEXT
);
```

#### 索引优化策略
```sql
CREATE INDEX idx_characters_type ON characters(type);
CREATE INDEX idx_characters_category ON characters(category);
CREATE INDEX idx_characters_rank ON characters(rank);
CREATE INDEX idx_characters_power ON characters(power);
CREATE INDEX idx_characters_name ON characters(name);
CREATE INDEX idx_characters_pinyin ON characters(pinyin);
```

### 服务器架构升级

#### SQLite版本服务器特性
- 文件: `src/server/dataServer-sqlite.js`
- 端口: 3003
- 完全兼容原有API接口
- 新增高级搜索功能

#### 关键API接口
```javascript
// 基础兼容接口
GET /api/characters      // 获取所有角色
GET /api/aliases         // 获取所有别名
GET /api/data/complete   // 获取完整数据
GET /api/stats           // 获取数据统计

// 新增高级搜索接口
GET /api/characters/search?q=关键词
GET /api/characters/search?category=类型
GET /api/characters/search?minPower=80&maxPower=100
```

#### 数据格式转换适配器
```javascript
function transformSqliteToFrontend(sqliteData) {
  return {
    id: sqliteData.unid,
    name: sqliteData.name,
    pinyin: sqliteData.pinyin,
    aliases: JSON.parse(sqliteData.aliases || '[]'),
    type: mapCharacterType(sqliteData.category),
    // ... 其他字段转换
    visual: generateVisualConfig(sqliteData),
    metadata: {
      source: 'sqlite',
      verified: true
    }
  };
}
```

### 性能优化实际效果

#### 量化性能指标
- **数据加载速度**: 14ms → 1ms (14倍提升)
- **文件管理**: 482个文件 → 1个数据库文件
- **存储空间**: 0.26MB → 0.43MB (包含更多功能)
- **查询能力**: 从无搜索 → 支持复杂SQL查询

#### 功能扩展价值
- **搜索功能**: 支持名称、拼音、描述的模糊搜索
- **过滤功能**: 按类型、能力范围等多维度过滤
- **关联查询**: 角色-别名关联查询
- **数据分析**: 支持统计和聚合查询

### 工具链开发记忆

#### 核心工具脚本
1. **环境测试**: `scripts/data-migration/test-migration.cjs`
2. **角色迁移**: `scripts/data-migration/migrate-fixed.cjs`
3. **别名迁移**: `scripts/data-migration/migrate-aliases.cjs`
4. **性能测试**: `scripts/data-migration/performance-test.cjs`
5. **服务器切换**: `scripts/switch-server.ps1`

#### 数据验证机制
```javascript
// 数据完整性验证
const characterCount = db.prepare('SELECT COUNT(*) as count FROM characters WHERE is_alias = 0').get().count;
const aliasCount = db.prepare('SELECT COUNT(*) as count FROM characters WHERE is_alias = 1').get().count;

// 关联关系验证
const aliasWithoutOriginal = db.prepare(`
  SELECT unid, name, alias_of 
  FROM characters 
  WHERE is_alias = 1 AND alias_of IS NULL
`).all();
```

### 关键实施经验记忆

#### 用户反馈的重要性
- **包管理器错误**: 用户纠正使用pnpm而非npm
- **数据完整性**: 用户发现别名数据缺失问题
- **及时调整**: 根据反馈快速修正和补充

#### 渐进式实施策略
1. **环境准备**: 依赖安装和数据备份
2. **核心迁移**: 角色数据迁移和验证
3. **服务器升级**: SQLite版本服务器部署
4. **功能补充**: 别名数据迁移和完善

#### 错误处理和回滚机制
- **完整备份**: 自动备份原始JSON数据
- **分步验证**: 每个阶段都有独立验证
- **回滚支持**: 提供完整的回滚脚本和流程

### 数据关联关系处理

#### 别名-角色关联设计
```javascript
// 别名文件结构
{
  "unid": "ca0001",
  "isAlias": true,
  "metadata": {
    "originalCharacter": "c0001"  // 关联到原角色
  }
}

// 数据库中的关联
{
  unid: "ca0001",
  name: "美猴王",
  is_alias: 1,
  alias_of: "c0001"  // 外键关联
}
```

#### 查询关联数据
```sql
-- 获取角色及其所有别名
SELECT 
  c.name as character_name,
  a.name as alias_name
FROM characters c
LEFT JOIN characters a ON c.unid = a.alias_of
WHERE c.is_alias = 0;
```

### 系统架构升级价值

#### 技术债务解决
- **文件数量**: 从482个文件到1个数据库
- **查询效率**: 从文件遍历到索引查询
- **数据一致性**: 从文件级到事务级保证
- **扩展能力**: 支持复杂查询和数据分析

#### 长期发展基础
- **现代化架构**: 建立了可扩展的数据管理基础
- **标准化接口**: 统一的数据访问方式
- **工具化支持**: 完整的迁移和管理工具链
- **性能基础**: 为未来功能扩展提供性能保障

这次SQLite数据迁移实施建立了完整的现代化数据管理体系，不仅解决了当前的性能问题，还为项目的长期发展奠定了坚实的技术基础。通过实际执行验证了理论分析的正确性，并在用户反馈的指导下不断完善和优化方案。
