# MEM160 - 事件角色关系图谱交互功能增强记忆

## 核心记忆点

### 1. 交互功能需求与解决方案
- **用户需求**: 空银河系81难点局部视图中的角色点长按拖拽 + 双击进入角色详情
- **解决方案**: 创建专用useEventCharacterInteraction Hook处理复杂交互逻辑
- **技术挑战**: 多状态交互管理、3D拖拽算法、类型安全转换

### 2. 核心交互机制设计
```typescript
交互时间常量:
- LONG_PRESS_DURATION = 500ms (长按检测)
- DOUBLE_CLICK_DURATION = 300ms (双击检测)  
- DRAG_THRESHOLD = 5px (拖拽阈值)

交互状态管理:
- hoveredIndex: 悬浮状态
- longPressIndex: 长按状态
- dragState: 拖拽状态（位置、时间、鼠标）
- lastClickIndex/Time: 双击检测
```

### 3. 长按拖拽算法核心
```typescript
拖拽触发条件:
1. 长按时间 >= 500ms
2. 鼠标移动距离 > 5px
3. 有效的角色球体命中

3D位置计算:
- 鼠标2D移动 → 3D空间坐标变化
- moveScale = 0.01 (移动敏感度)
- 在XZ平面上移动，保持Y轴相对稳定
```

### 4. 视觉反馈系统
```typescript
球体大小变化:
- 拖拽时: baseSize *= 1.2
- 悬浮时: baseSize *= 1.1  
- 长按时: baseSize *= 1.15

颜色变化:
- 拖拽时: color.multiplyScalar(1.5) (更亮)
- 悬浮时: color.multiplyScalar(1.2) (稍亮)
- 长按时: color.lerp(white, 0.3) (偏白)

连接线变化:
- 正常状态: opacity = 0.3
- 拖拽时: opacity = 0.6 (更明显)
```

### 5. 双击进入详情机制
```typescript
检测逻辑:
- 记录lastClickIndex和lastClickTime
- 300ms内相同索引点击 = 双击
- 双击时清除其他交互状态

类型转换策略:
1. 优先使用character.character (完整CharacterData)
2. 否则创建临时CharacterData对象
3. 包含必要字段: id, name, type, visual, metadata
```

### 6. 临时位置管理系统
```typescript
存储机制:
- temporaryPositions: Map<number, Vector3>
- 拖拽时存储临时位置
- 重置时清空Map

位置获取优先级:
1. temporaryPositions.get(index) (拖拽后位置)
2. character.position (原始位置)
```

### 7. 事件监听器管理
```typescript
绑定事件:
- pointerdown: 开始交互检测
- pointermove: 拖拽位置更新
- pointerup: 结束交互状态
- pointerleave: 鼠标离开也结束拖拽

清理机制:
- useEffect返回清理函数
- 组件卸载时自动清理事件监听器
```

### 8. 组件集成架构
```
EventDetailScene (主场景)
├── 控制按钮区域
│   ├── 显示/隐藏关系图谱按钮
│   └── 🔄 重置位置按钮 (新增)
├── 交互说明面板 (新增)
└── EventCharacterGraph (关系图谱)
    ├── useEventCharacterInteraction Hook (新增)
    ├── 动态位置更新
    └── 视觉状态反馈
```

### 9. 用户界面优化
```typescript
重置按钮样式:
- backgroundColor: '#FF9800' (橙色)
- title: "重置角色位置"
- 触发resetTrigger状态更新

交互说明面板:
- 位置: 左下角 (bottom: 20px, left: 20px)
- 背景: rgba(0,0,0,0.8) 半透明黑色
- 内容: 长按拖拽、双击进入、重置位置说明
- 显示条件: showCharacterGraph为true时显示
```

### 10. 性能优化策略
```typescript
事件处理优化:
- useCallback包装事件处理函数
- useRef存储raycaster和mouse避免重复创建
- 射线检测复用，避免每帧创建新实例

状态更新优化:
- 批量状态更新，减少重渲染
- 条件检查避免无效更新
- 临时位置Map管理，避免数组操作
```

### 11. 类型安全处理
```typescript
EventCharacter → CharacterData转换:
- 检查character.character是否存在
- 创建符合CharacterData接口的临时对象
- 包含所有必需字段: type, faction, level, visual, metadata
- 使用CharacterType.HUMAN作为默认类型
```

### 12. 文件组织结构
```
新增文件:
src/hooks/useEventCharacterInteraction.ts (300行)

修改文件:
src/components/three/Scenes/EventDetailScene/EventDetailScene.tsx
src/components/three/Scenes/EventDetailScene/components/EventCharacterGraph.tsx

核心功能分布:
- Hook: 交互逻辑和状态管理
- Graph组件: 视觉效果和位置更新  
- Scene组件: UI控制和用户提示
```

### 13. 关键学习点
1. **复杂交互设计**: 多状态交互系统的设计和实现
2. **3D拖拽算法**: 鼠标2D移动到3D空间坐标转换
3. **React Hook封装**: 复杂逻辑的Hook化封装
4. **类型安全转换**: 不同数据类型间的安全转换
5. **性能优化**: 事件监听器和状态管理优化

### 14. 测试和验证要点
- ✅ TypeScript编译通过
- ✅ 项目正常启动 (http://localhost:3001/)
- 🔄 待测试: 长按拖拽实际效果
- 🔄 待测试: 双击进入详情体验
- 🔄 待测试: 移动端触摸兼容性

### 15. 下一步优化方向
1. **移动端适配**: 触摸事件处理和手势识别
2. **拖拽边界**: 添加范围限制和碰撞检测
3. **动画过渡**: 位置变化的平滑动画
4. **多选拖拽**: 支持选择多个角色同时拖拽
5. **弹性物理**: 角色间斥力和弹性效果

### 16. 技术债务记录
- 部分TypeScript警告需清理（未使用导入）
- 移动端触摸交互兼容性待测试
- 拖拽边界和碰撞检测待实现
- CharacterLabel组件未使用，可考虑移除

## 实现价值
1. **用户体验**: 提供直观的拖拽和导航交互
2. **技术积累**: 复杂3D交互系统的实现经验
3. **架构优化**: Hook化的交互逻辑封装
4. **功能完整性**: 事件详情视图的交互功能完善
