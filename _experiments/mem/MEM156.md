# MEM156 - Three.js射线检测与交互效果优化

## 核心记忆

在本次工作中，我深入研究并解决了Three.js中InstancedMesh射线检测与交互效果的问题。

### 1. Raycaster正确实现方法

Three.js中实现射线检测的标准流程：

```typescript
// 1. 创建射线检测器与鼠标向量
const raycaster = new Raycaster()
const mouse = new Vector2()

// 2. 正确计算归一化设备坐标(NDC)
function updateMousePosition(event) {
  const rect = renderer.domElement.getBoundingClientRect()
  const x = event.clientX - rect.left
  const y = event.clientY - rect.top
  mouse.x = (x / rect.width) * 2 - 1
  mouse.y = -(y / rect.height) * 2 + 1
}

// 3. 设置射线从相机发出通过鼠标点
raycaster.setFromCamera(mouse, camera)

// 4. 获取射线与物体的交点
const intersects = raycaster.intersectObject(mesh)

// 5. InstancedMesh特殊处理
if (intersects.length > 0) {
  const instanceId = intersects[0].instanceId
  // 通过instanceId可以确定点击了哪个实例
}
```

**关键点**：
- 必须正确计算归一化设备坐标，坐标系为[-1, 1]
- InstancedMesh会返回instanceId，表示点击的是哪个实例
- 事件监听器应直接绑定到renderer.domElement上

### 2. React Three Fiber中的最佳实践

虽然React Three Fiber提供了useThree钩子获取raycaster和pointer，但在某些场景下自己实现更可靠：

```typescript
// 在React组件中
const { camera, gl } = useThree()
const raycaster = useMemo(() => new Raycaster(), [])
const mouse = useMemo(() => new Vector2(), [])

useEffect(() => {
  const canvas = gl.domElement
  canvas.addEventListener('pointermove', handlePointerMove)
  canvas.addEventListener('pointerdown', handlePointerDown)
  
  return () => {
    canvas.removeEventListener('pointermove', handlePointerMove)
    canvas.removeEventListener('pointerdown', handlePointerDown)
  }
}, [/* 依赖项 */])
```

### 3. 交互效果设计原则

本次改进中发现的重要设计原则：

1. **状态明确化**：
   - 悬停状态使用一种颜色(#00aaff蓝色)
   - 选中状态使用另一种颜色(#ffffff白色)
   - 不同状态大小也有区别(悬停1.5倍，选中1.8倍)

2. **动静对比**：
   - 静态效果用于强调关注点
   - 动态效果用于增强沉浸感和活力

3. **层次感表达**：
   - 主体(球体)静态固定大小
   - 辅助层(外壳)保持动态效果
   - 这种对比增强了视觉层次和空间感

### 4. 版本控制最佳实践

在开发过程中使用的Git工作流：

```bash
# 1. 修改代码并更新版本号
git add .
git commit -m "fix: 修复JourneyPoints射线检测算法并改进视觉效果"

# 2. 创建版本标签
git tag -a v1.2.2 -m "v1.2.2: 修复JourneyPoints射线检测算法与交互效果"

# 3. 推送到远程仓库
git push origin <branch>
git push origin v1.2.2

# 4. 分支管理(将feature分支覆盖到main)
git checkout main
git reset --hard <feature-branch>
git push -f origin main
```

## 关键代码模式

```typescript
// 条件性脉冲效果模式
let pulseScale = 1.0
if (i !== selectedIndex && i !== hoveredIndex) {
  pulseScale = 1 + Math.sin(deltaTime * factor) * intensity
}

// 状态区分动画模式
if (i === hoveredIndex) {
  sizeVariation = 1.5  // 固定值，无动画
} else if (i === selectedIndex) {
  sizeVariation = 1.8  // 固定值，无动画
} else {
  // 应用动画效果
  sizeVariation = 1 + Math.sin(deltaTime * factor) * intensity
}
```

这些模式可以应用于其他需要条件性应用动画效果的场景。

## 应用领域

这次学到的射线检测和交互效果优化技术可应用于：

1. 3D数据可视化系统中选择数据点
2. Web 3D产品展示中的产品交互
3. 3D地图中的位置选择
4. 基于Three.js的教育和展示应用
5. 虚拟现实和增强现实中的对象交互 