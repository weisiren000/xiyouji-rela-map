# MEM07: 端口自动检测和系统适应性记忆

## 核心技术记忆

### 端口自动检测机制
- **检测策略**: 多端口优先级扫描 [3003, 3002, 3001, 3000, 8080, 8000]
- **检测方法**: HTTP HEAD请求到 `/api/stats` 端点，2秒超时
- **缓存机制**: 成功检测后缓存端口信息，避免重复扫描
- **重试策略**: API失败时自动重新检测端口

### 智能API服务架构
```typescript
// 核心函数签名
async function detectBackendPort(): Promise<number | null>
async function apiRequest<T>(endpoint: string, options?: RequestInit): Promise<T>
static async checkConnection(): Promise<boolean>
static setApiPort(port: number): void
```

### 启动脚本设计模式
- **PowerShell版本**: 功能完整，支持详细参数和错误处理
- **批处理版本**: 简化版本，基础功能覆盖
- **自动配置**: 动态更新后端服务器端口配置
- **依赖检查**: Node.js、pnpm环境验证和自动安装

## 用户偏好记忆

### 端口配置偏好
- 用户偏好自动端口检测而不是手动配置
- 用户希望有可视化的端口状态指示器
- 用户偏好一键启动脚本而不是分步操作
- 用户希望在连接失败时有详细的错误信息和解决建议

### 启动流程偏好
- 用户偏好使用PowerShell脚本 (`pnpm run start:auto`)
- 用户希望启动过程有实时状态反馈
- 用户偏好自动依赖检查和安装
- 用户希望前后端服务协调启动

### 界面设计偏好
- 用户偏好端口状态指示器位于应用右上角
- 用户希望状态指示器使用颜色编码 (绿色/红色/橙色)
- 用户偏好点击状态指示器可以手动重新检测
- 用户希望有详细的端口配置面板选项

## 技术实现记忆

### 错误处理模式
- **网络错误**: 自动尝试下一个端口，不中断用户操作
- **超时处理**: 2秒超时设置，避免长时间等待
- **用户反馈**: 实时状态更新，清晰的错误信息显示
- **降级策略**: 检测失败时使用默认端口3003

### 组件集成模式
- 所有API调用统一使用 `DataApi` 服务
- 组件不直接硬编码端口号
- 类型定义与后端数据结构保持同步
- 状态管理使用React hooks和状态提升

### 性能优化记忆
- **智能缓存**: 端口检测成功后缓存结果
- **定期检查**: 30秒间隔进行连接健康检查
- **按需扫描**: 只在连接失败时重新进行端口检测
- **超时控制**: 避免长时间阻塞用户界面

## 问题解决模式记忆

### 端口冲突解决
1. **自动检测**: 扫描多个常用端口
2. **动态配置**: 运行时更新后端配置文件
3. **状态验证**: 启动后验证服务可用性
4. **用户反馈**: 显示最终使用的端口号

### 前后端通信问题
1. **统一API层**: 所有组件通过DataApi服务通信
2. **自动重试**: API请求失败时自动重新检测端口
3. **错误恢复**: 连接失败时提供手动配置选项
4. **状态同步**: 实时显示连接状态和端口信息

## 开发工作流记忆

### 启动命令偏好
```bash
# 推荐使用 (PowerShell增强版)
pnpm run start:auto

# 详细输出版本 (调试时使用)
pnpm run start:auto:verbose

# 批处理版本 (兼容性)
pnpm run start:auto:bat
```

### 调试和诊断
- 端口状态指示器提供实时诊断信息
- 启动脚本输出详细的检查和配置过程
- API服务提供连接状态检查方法
- 错误信息包含具体的解决建议

## 系统架构记忆

### 分层设计
1. **API服务层**: `src/services/dataApi.ts` - 统一的后端通信
2. **组件层**: React组件使用DataApi，不直接处理端口
3. **状态层**: 端口状态指示器和全局状态管理
4. **脚本层**: 智能启动脚本处理环境配置

### 配置管理
- 端口配置动态管理，不依赖静态配置文件
- 类型定义与后端API保持同步
- 启动脚本自动更新后端配置
- 用户可以手动覆盖自动检测结果

## 用户体验设计记忆

### 状态可见性
- 端口连接状态实时显示
- 启动过程进度反馈
- 错误信息清晰易懂
- 成功状态明确确认

### 操作简化
- 一键启动替代多步操作
- 自动配置减少手动设置
- 智能重试减少用户干预
- 可选的手动控制保留用户选择权

## 扩展性考虑记忆

### 未来功能方向
- 支持更多服务发现协议 (如mDNS, Consul)
- 添加负载均衡和故障转移机制
- 实现配置持久化和用户偏好保存
- 支持多后端实例和集群部署

### 技术债务管理
- 定期更新端口检测逻辑
- 监控和优化检测性能
- 保持类型定义与API同步
- 维护启动脚本的跨平台兼容性

## 关键成功因素记忆

### 技术因素
- 多端口检测策略的有效性
- 自动重试机制的可靠性
- 状态指示器的实时性
- 启动脚本的健壮性

### 用户体验因素
- 零配置启动体验
- 清晰的状态反馈
- 详细的错误诊断
- 保留的手动控制选项

这次实现显著提升了系统的适应性和用户体验，为后续的功能扩展奠定了坚实的基础。
