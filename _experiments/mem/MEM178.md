# MEM178 - 星谱界面拖拽功能重启记忆

## 核心记忆点

### 拖拽功能集成方式
- 星谱界面拖拽功能需要在CharacterSpheresSimple组件中使用`useGalaxyCharacterDrag` hook
- 不能使用普通的`useCharacterInteraction`，必须使用专门的拖拽交互系统
- 拖拽状态需要通过`dragInteractionState`而不是`interactionState`来管理

### 关键技术实现
- 拖拽算法使用基于视角的射线投影计算：`calculateDragPositionByRayProjection`
- 长按检测时间：300ms
- 拖拽边界限制：最大距离100单位
- 视角控制协调：拖拽时禁用OrbitControls，结束后恢复

### 状态管理模式
```typescript
const [dragStatus, setDragStatus] = useState<string>('')
const [controlsEnabled, setControlsEnabled] = useState(true)

const { 
  interactionState: dragInteractionState, 
  bindMouseEvents: bindDragEvents,
  resetTemporaryPositions 
} = useGalaxyCharacterDrag(
  charactersWithPosition,
  mainMeshRef,
  onCharacterPositionUpdate,
  setDragStatus,
  setControlsEnabled
)
```

### 交互流程设计
1. 鼠标按下 → 长按检测开始
2. 300ms后 → 进入拖拽模式，禁用视角控制
3. 鼠标移动 → 实时位置计算和更新
4. 鼠标释放 → 结束拖拽，恢复视角控制

### 用户体验要点
- 长按拖拽：直观的操作方式
- 状态反馈：屏幕顶部显示拖拽状态
- 双击保留：双击进入角色详情视图
- 无冲突交互：拖拽时视角控制自动禁用

### 常见问题解决
- 如果拖拽不工作，检查是否使用了正确的hook（useGalaxyCharacterDrag）
- 如果状态不同步，确认使用dragInteractionState而不是interactionState
- 如果有重复显示，清理GalaxyScene中的重复状态组件

### 项目结构记忆
- 拖拽功能主要在：`src/hooks/useGalaxyCharacterDrag.ts`
- 集成位置：`src/components/three/Galaxy/components/CharacterSpheresSimple/CharacterSpheresSimple.tsx`
- 状态显示：`src/scenes/GalaxyScene.tsx`

### 性能考虑
- 事件绑定需要正确清理，避免内存泄漏
- 拖拽计算使用优化的算法，确保流畅性
- 边界检查防止性能问题

这次重启拖拽功能的经验表明，星谱界面的交互功能需要使用专门的拖拽系统，而不是通用的交互系统。
