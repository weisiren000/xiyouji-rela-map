# EXP82 - 角色数据球可见性问题调试

## 时间
2025-06-14 23:15

## 问题描述
用户发现数据文件已经加载成功（150个角色+332个别名），但在3D场景中看不到对应的角色数据球。

## 问题分析过程

### 已确认的正常状态
1. **数据服务器**: ✅ 运行在localhost:3002，正常响应API请求
2. **数据加载**: ✅ 控制台显示"✨ 渲染 150 个角色球体"
3. **API修复**: ✅ 已修复CharacterSpheres组件中的端口问题(3001→3002)
4. **数据结构**: ✅ 服务器正确生成visual配置(颜色、大小、发光强度)

### 发现的问题
1. **尺寸问题**: 角色球默认尺寸可能太小(0.8倍数)，在银河系中不可见
2. **颜色问题**: 角色球颜色可能在黑色背景中不够明显
3. **位置问题**: 角色球可能被银河系其他元素遮挡

### 调试过程
1. **尺寸调整**: 尝试将尺寸从0.8调整到3.0、8.0，但用户反馈太大
2. **恢复原始**: 按用户要求恢复到原始的0.8倍数
3. **可见性测试**: 尝试禁用星空和雾气效果来突出角色球
4. **控制面板**: 尝试通过Character Control面板调整参数

## 当前状态

### 数据流程确认
- **JSON文件** → **数据服务器** → **API响应** → **前端加载** → **3D渲染**
- 每个环节都正常工作，问题在最后的可见性

### 位置生成逻辑
用户选中了CharacterSpheres.tsx中的位置生成代码：
- 基于角色排名决定距离中心的远近
- 基于角色类别决定螺旋臂位置
- 支持radiusMultiplier等控制参数

### 可能的根本原因
1. **默认尺寸太小**: 0.8倍数在银河系尺度中几乎不可见
2. **发光强度不足**: 默认发光强度可能不够亮
3. **相机视角**: 可能需要调整相机位置才能看到角色球
4. **渲染层级**: 角色球可能被其他3D对象遮挡

## 下一步调试方案

### 方案1: 调整默认参数
- 适度增加默认尺寸倍数(1.2-1.5)
- 提高默认发光强度
- 确保角色球在合理的可见范围内

### 方案2: 添加调试信息
- 在控制台输出角色球的实际位置坐标
- 显示角色球的实际尺寸和颜色值
- 添加可见性检查逻辑

### 方案3: 相机控制
- 提供快速定位到角色球的功能
- 调整初始相机位置
- 添加角色球区域的可视化边界

## 技术细节

### 数据服务器visual配置生成
```javascript
function generateVisualConfig(rawData) {
  const rank = rawData.attributes.rank
  const power = rawData.attributes.power || 50
  const category = rawData.basic.category
  
  // 颜色映射
  const colorMap = {
    'protagonist': '#FFD700',    // 金色
    'deity': '#87CEEB',          // 天蓝色
    'demon': '#FF6347',          // 红色
    // ... 其他类别
  }
  
  // 基于排名的大小 (0.5-2.0)
  const size = Math.max(0.5, 2.0 - (rank / 150) * 1.5)
  
  // 基于能力的发光强度 (0.1-0.8)
  const emissiveIntensity = Math.max(0.1, Math.min(1.0, power / 100 * 0.8))
  
  return { color, size, emissiveIntensity }
}
```

### 前端渲染逻辑
```typescript
// 当前的尺寸计算
tempObject.scale.setScalar(character.visual.size * globalSize * 0.8)

// 位置计算基于银河系配置
const baseRadius = galaxyConfig.galaxyRadius * (0.2 + normalizedRank * 0.6) * radiusMultiplier
```

## 用户反馈
- 用户明确反对过大的尺寸调整
- 要求恢复到原始的0.8倍数
- 期望看到实际的角色数据球

## 风险评估
- **技术风险**: 低 - 数据流程正常，只是可见性问题
- **用户满意度**: 中 - 用户期望看到明显的效果
- **项目进度**: 低 - 这是显示效果的优化问题

## 教训
1. **不要盲目调整参数**: 应该先分析根本原因再调整
2. **尊重用户反馈**: 用户说太大就是太大，要立即调整
3. **系统性调试**: 需要从多个角度分析可见性问题

## 备注
这个问题需要细致的调试，可能需要在保持原始尺寸的前提下，通过其他方式提高角色球的可见性，比如调整发光强度、颜色对比度或相机视角。
