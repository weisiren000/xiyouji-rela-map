# SUM164: 事件局部视图关系图谱线条实时跟随功能实现

## 对话时间
2025-06-28

## 用户需求
用户希望让事件局部视图的关系图谱的线条能够实时跟随拖动球体移动，包括浮动动画效果的同步。

## 问题诊断
通过代码分析发现了关系图谱连接线无法完全跟随球体移动的根本原因：

### 1. BufferGeometry 更新机制问题
- `ConnectionLine` 组件使用 `useMemo` 缓存点位置
- `bufferAttribute` 数组创建后不会自动更新
- 需要手动触发几何体属性更新

### 2. 位置同步不完整
- 球体位置包含：基础位置 + 拖拽偏移 + 浮动效果
- 连接线只使用了基础位置，缺少浮动效果同步
- 导致视觉不一致

## 解决方案实施

### 1. 优化 ConnectionLine 组件
**文件**: `src/components/three/Scenes/EventDetailScene/components/EventCharacterGraph.tsx`

**核心改进**:
```typescript
const ConnectionLine: React.FC<ConnectionLineProps> = ({
  start, end, color, opacity = 0.5
}) => {
  const geometryRef = useRef<BufferGeometry>(null)
  
  // 实时更新线条位置
  useEffect(() => {
    if (geometryRef.current) {
      const positions = new Float32Array([
        start[0], start[1], start[2],
        end[0], end[1], end[2]
      ])
      
      geometryRef.current.setAttribute('position', new BufferAttribute(positions, 3))
      geometryRef.current.attributes.position.needsUpdate = true
    }
  }, [start, end])
}
```

### 2. 实现实时位置跟踪系统
**新增功能**:
- 添加 `realTimePositions` ref 存储实时球体位置
- 在 `useFrame` 中同步更新位置数组
- 创建 `getRealTimePosition` 获取包含所有效果的位置
- 连接线使用实时位置进行渲染

**关键代码**:
```typescript
// 存储实时球体位置（包含浮动效果）
const realTimePositions = useRef<Vector3[]>([])

// useFrame 中存储实时位置
tempObject.position.y += Math.sin(time * 2 + i * 0.5) * floatIntensity
realTimePositions.current[i].copy(tempObject.position)

// 连接线使用实时位置
const currentPosition = getRealTimePosition(index)
```

### 3. 导入和类型修复
- 添加 `useCallback` 导入
- 修复 `BufferAttribute` 和 `BufferGeometry` 类型导入
- 解决 TypeScript 编译错误

## 技术实现细节

### 1. 几何体实时更新机制
- 使用 `geometryRef` 直接操作 BufferGeometry
- 通过 `setAttribute` 更新位置属性
- 设置 `needsUpdate = true` 强制重新渲染

### 2. 位置同步策略
- 球体渲染：基础位置 → 添加浮动 → 更新矩阵
- 位置存储：同时保存到 `realTimePositions`
- 连接线：使用存储的实时位置

### 3. 性能优化措施
- 复用 Vector3 对象避免频繁创建
- 使用 `useCallback` 缓存函数
- 只在位置变化时更新几何体

## 实现结果
1. ✅ 连接线完全跟随球体拖拽移动
2. ✅ 连接线同步球体浮动动画效果  
3. ✅ 拖拽时连接线透明度动态调整
4. ✅ 代码编译无错误，热更新正常
5. ✅ 性能优化，避免不必要的重新渲染

## 项目状态
- 前端服务：http://localhost:3001 (正常运行)
- 后端服务：http://localhost:3003 (正常运行)
- 数据库：SQLite (482个角色，81个事件)
- 热更新：正常工作

## 测试建议
用户可以在浏览器中测试以下功能：
1. 进入空银河系页面
2. 点击任意事件点进入局部视图
3. 长按拖动关系图谱中的角色球体
4. 观察连接线是否实时跟随移动
5. 验证浮动动画效果的同步性

## 后续优化方向
1. 添加连接线弹性动画效果
2. 优化大量角色时的渲染性能
3. 增加连接线样式选项（虚线、渐变等）
4. 考虑添加连接线的交互功能
